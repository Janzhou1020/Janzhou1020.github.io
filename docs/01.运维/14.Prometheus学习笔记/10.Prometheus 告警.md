---
title: Prometheus å‘Šè­¦
date: 2024-11-02 09:51:37
permalink: /pages/prometheus10/
categories:
  - è¿ç»´
  - Prometheus
tags:
  - Prometheus
author: æ˜Ÿé€”ç‰©è¯­
---
### é‚®ä»¶ï¼ˆGrafanaï¼‰

Grafana Alertingæ”¯æŒå¤šç§å‘Šè­¦æ¸ é“ï¼Œæ¯”å¦‚é’‰é’‰ï¼ŒDiscordï¼ŒEmailï¼ŒKafkaï¼ŒPushoverï¼ŒTelegramï¼ŒWebHookç­‰ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥ä½¿ç”¨Emailè¿›è¡Œå±•ç¤º

**1.å¼€å¯å‘Šè­¦é…ç½®**

Emailæ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„å‘Šè­¦æ¥å…¥æ–¹å¼ï¼Œé€šè¿‡Grafanaå‘Šè­¦éœ€è¦åœ¨Grafanaçš„é…ç½®æ–‡ä»¶ä¸­é…é¥°SMTPæœåŠ¡ï¼Œåœ¨é…ç½®/etc/grafana/grafana.iniä¸­ï¼Œå¤§æ¦‚åœ¨626è¡Œï¼Œå¼€å¯å‘Šè­¦ 820è¡Œå·¦å³ï¼ˆç›´æ¥ç”¨ / æŸ¥æ‰¾ï¼‰

 <img src="/img/image-20241228202622676.png" alt="image-20241228202622676" style="zoom:80%;" /> <img src="/img/image-20241228202800719.png" alt="image-20241228202800719" style="zoom:80%;" />é‡å¯Grafanaï¼šsystemctl restart grafana-server.service

**2.é…ç½®é€šçŸ¥æ¸ é“ï¼ˆé‚®ä»¶æ¥æ”¶è€…ï¼‰**

åœ¨ä¸åŒç‰ˆæœ¬çš„ Grafana ä¸­è¿™é‡Œå¯èƒ½å«æ³•ä¸åŒ

 <img src="/img/image-20241228204342590.png" alt="image-20241228204342590" style="zoom:80%;" /><img src="/img/image-20241228204458125.png" alt="image-20241228204458125" style="zoom:80%;" /> <img src="/img/image-20241228204827557.png" alt="image-20241228204827557" style="zoom:80%;" />

 <img src="/img/image-20241230150931537.png" alt="image-20241230150931537" style="zoom:80%;" />**3.æ·»åŠ æŠ¥è­¦è§„åˆ™**

ä½†æ˜¯è¿™é‡Œé¢æˆ‘ä»¬è¦æ³¨æ„ï¼Œå®ƒå¹¶ä¸èƒ½è¯†åˆ«æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥ä¸­çš„å˜é‡ï¼šhostï¼Œinterval ç­‰çš„ä¿¡æ¯ï¼Œé‚£é‡åˆ°è¿™ç§æƒ…å†µæˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å¤åˆ¶ä¸€æ¡è¯­å¥ç„¶ååœ¨ä¸‹é¢åˆ›å»ºä¸€ä¸ªæ–°çš„æŸ¥è¯¢ï¼ˆä¸ç”¨äºå±•ç¤ºï¼‰

ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š

1. æ–°å»ºçš„æŸ¥è¯¢è¯­å¥ä¸å±•ç¤ºåœ¨Panelä¸Š
2. æŸ¥è¯¢è¯­å¥å¿…é¡»æ˜¯å›ºå®šçš„å‚æ•°ï¼Œä¸èƒ½æ˜¯å˜é‡

 <img src="/img/image-20241230093816081.png" alt="image-20241230093816081" style="zoom:80%;" />

<img src="/img/image-20241230151112519.png" alt="image-20241230151112519" style="zoom:80%;" />

å¦å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å» Dashboard å†…åˆ›å»ºæŠ¥è­¦

**4.è®¾ç½® Notification policiesï¼ˆæŠ¥è­¦åŒ¹é…è§„åˆ™ï¼‰**

å› ä¸º alert ruleï¼ˆæŠ¥è­¦è§„åˆ™ï¼‰ æ˜¯é€šè¿‡ label æ¥åŒ¹é… contact pointï¼ˆé€šçŸ¥ç­–ç•¥ï¼‰

æ‰€ä»¥éœ€è¦å®šä¹‰ä¸€ä¸ª Notification policyï¼Œç»™ contact point å®šä¹‰ label

 <img src="/img/image-20241230162918310.png" alt="image-20241230162918310" style="zoom:80%;" />**5.ç»™ alert rules è®¾ç½® lableï¼Œç»‘å®šé€šçŸ¥æ–¹å¼**

 <img src="/img/image-20241230165501195.png" alt="image-20241230165501195" style="zoom:80%;" />æ¥ä¸‹æ¥å¯¹å†…å­˜è¿›è¡Œå‹æµ‹ï¼Œè§‚å¯Ÿé‚®ä»¶å‘é€

dd if=/dev/zero of=/dev/null bs=1G count=102400

 <img src="/img/image-20241230165908012.png" alt="image-20241230165908012" style="zoom:80%;" /> <img src="/img/image-20241230165849380.png" alt="image-20241230165849380" style="zoom:80%;" />



### å¤šåºåˆ—

æˆ‘ä»¬ç»å¸¸åœ¨ç›‘æ§æŠ¥è­¦çš„æŸ¥è¯¢ä¸­ä¼šè¿”å›å¤šä¸ªåºåˆ—ï¼ŒGrafana çš„æŠ¥è­¦ä¸­çš„èšåˆå‡½æ•°å’Œé˜ˆå€¼æ£€æµ‹éƒ½ä¼šå»è¯„ä¼°æ¯ä¸€ä¸ªåºåˆ—ï¼Œä½†æ˜¯åœ¨ Grafana ç›®å‰ä¸ä¼šå»è·Ÿè¸ªæ¯ä¸ªåºåˆ—çš„æŠ¥è­¦è§„åˆ™çŠ¶æ€ï¼Œæ‰€ä»¥è¿™ä¼šå½±å“åˆ°æˆ‘ä»¬çš„æŠ¥è­¦ç»“æœ

å…·ä½“è¿‡ç¨‹ï¼š

```
1.æŠ¥è­¦è¿”å›ä¸¤ä¸ªåºåˆ— server_1å’Œserver_2
2.server_1è§¦å‘äº†æŠ¥è­¦è§„åˆ™å¹¶åˆ‡æ¢åˆ°äº†æŠ¥è­¦çŠ¶æ€
3.å‘é€æ¶ˆæ¯é€šçŸ¥å‡ºå»ï¼Œæ¯”å¦‚å‘é€çš„æ¶ˆæ¯æ˜¯ï¼šè´Ÿè½½è¾¾åˆ°äº†80%ï¼ˆserver_1ï¼‰
4.å¦‚æœåœ¨åŒä¸€æŠ¥è­¦è§„åˆ™çš„åç»­è¯„ä¼°ä¸­ï¼Œserver_2åºåˆ—ä¹Ÿä¼šå¯¼è‡´è§¦å‘äº†æŠ¥è­¦
5.è¿™ä¸ªæ—¶å€™ä¸ä¼šå‘é€æ–°çš„é€šçŸ¥ï¼Œå› ä¸ºæŠ¥è­¦è§„åˆ™å·²ç»å¤„äºæŠ¥è­¦çŠ¶æ€ä¹‹ä¸‹äº†
```

æ‰€ä»¥ä»ä¸Šé¢çš„åœºæ™¯å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè§„åˆ™å¤„äºå‘Šè­¦çŠ¶æ€äº†ï¼Œå½“å…¶åºåˆ—ä¹Ÿè¾¾åˆ°äº†æŠ¥è­¦æ¡ä»¶åï¼ŒGrafanaä¸ä¼šå‘é€æ¶ˆæ¯é€šçŸ¥ï¼Œç›®å‰Grafanaå®˜æ–¹æœ‰é’ˆå¯¹å¤šä¸ªåºåˆ—æŸ¥è¯¢çš„æ”¯æŒï¼Œä¼šåœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­è·Ÿè¸ªæ¯ä¸€ä¸ªåºåˆ—çš„çŠ¶æ€ï¼Œæ‰€ä»¥ç›®å‰ä¹Ÿæ˜¯GrafanaåŠŸèƒ½çš„ä¸€ä¸ªå±€é™æ€§

### å‘Šè­¦æ¨¡æ¿

å°±æ˜¯ä¸€ä¸ªå¯ä»¥ä¼ è¿›æ¥çš„å˜é‡

 <img src="/img/image-20241231142044087.png" alt="image-20241231142044087" style="zoom:80%;" />

### PushGateway

æˆ‘ä»¬éƒ½çŸ¥é“ Prometheus é‡‡é›†æ•°æ®ä½¿ç”¨çš„æ˜¯pullçš„æ–¹å¼ï¼Œä½†æ˜¯åœ¨æŸäº›ç½‘ç»œä¸‹ï¼ˆä¸åœ¨ä¸€ä¸ªå­ç½‘æˆ–è€…é˜²ç«å¢™ï¼‰ï¼ŒPrometheusæ— æ³•ç›´æ¥æ‹‰å–ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªå’Œèƒ½å¤Ÿä¸»åŠ¨pushçš„æ¨¡å¼äº†ï¼Œè€ŒPushGatewayå°±æ˜¯Prometheusç”Ÿæ€ä¸­æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ª
å·¥å…·

ä½†æ˜¯æŠŠPushGatewayä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå…¶æœ¬èº«ä¹Ÿå­˜åœ¨ä¸€äº›å¼Šç«¯

- å°†å¤šä¸ªèŠ‚ç‚¹æ•°æ®æ±‡èšåˆ°pushgatewayï¼Œå¦‚æœpushgatewayæŒ‚äº†ï¼Œä¼šæ”¶åˆ°å¾ˆå¤§èŒƒå›´çš„å½±å“
- Prometheusæ‹‰å–çŠ¶æ€upåªé’ˆå¯¹pushgatewayæ— æ³•åšåˆ°å¯¹æ¯ä¸ªç›®æ ‡æœ‰æ•ˆ

ç”±äº pushgateway å¯ä»¥æŒä¹…åŒ–æ¨é€ç»™å®ƒæ‰€æœ‰ç›‘æ§æ•°æ®ï¼Œæ‰€ä»¥å³ä½¿ä½ çš„ç›‘æ§å·²ä¸‹çº¿ï¼ŒPrometheusè¿˜ä¼šæ‹‰å–åˆ°æ—§çš„ç›‘æ§æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†Pushgatewayä¸è¦çš„æ•°æ®

ä¸‹è½½åå¯åŠ¨ä¸€ä¸‹

 <img src="/img/image-20241231153719542.png" alt="image-20241231153719542" style="zoom:80%;" />Pushgatewayçš„æ•°æ®æ¨é€æ”¯æŒä¸¤ç§æ–¹å¼ï¼šPrometheus Client SDKæ¨é€å’ŒAPIæ¨é€

**Client SDK æ¨é€**

Prometheusæœ¬èº«å…¶å®æ”¯æŒäº†å¤šç§è¯­è¨€çš„SDKï¼Œå¯é€šè¿‡SDKçš„æ–¹å¼ç”Ÿæˆç›¸å…³çš„æ•°æ®ï¼Œå¹¶æ¨é€åˆ°Pushgatewayï¼Œå½“ç„¶äº†è¿™ç§æ–¹å¼éœ€è¦å®¢æˆ·ç«¯ä»£ç æ”¯æŒï¼Œè¿™ä¹Ÿæ˜¯å®˜æ–¹æ¨èçš„æ–¹æ¡ˆï¼Œç›®å‰SDKæ”¯æŒçš„è¯­è¨€ï¼šGoã€Java or Scalaã€Pythonã€Rubyã€Rust

å½“ç„¶ä¹Ÿæœ‰è®¸å¤šçš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¯¦æƒ…å‚è€ƒï¼šhttps://prometheus.io/docs/instrumenting/clientlibs

è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Pythonä¸ºä¾‹ï¼Œå› ä¸ºæˆ‘è¿™é‡Œæ˜¯Python3ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨pip3 å®‰è£…ä¸€ä¸‹ prometheusçš„sdkå¼€å‘åŒ…

pip3 install prometheus-client -i "https://mirrors.aliyun.com/pypi/simple"

å¦‚æœæœ‰å…¬é’¥éªŒè¯ï¼špip3 install prometheus-client --trusted-host mirrors.aliyun.com -i "http://mirrors.aliyun.com/pypi/simple"

SDK ç¤ºä¾‹

```
from prometheus_client import CollectorRegistry, Gauge, push_to_gateway
# åˆ›å»ºä¸€ä¸ªæŒ‡æ ‡æ³¨å†Œè¡¨
registry = CollectorRegistry()
# åˆ›å»ºä¸€ä¸ª Gauge æŒ‡æ ‡
g = Gauge('example_metric', 'This is an example metric', registry=registry)
# è®¾ç½®æŒ‡æ ‡çš„å€¼
g.set(123.45)
# æ¨é€åˆ° Pushgateway
push_to_gateway('http://localhost:9091', job='example_job', registry=registry)
print("Metric pushed successfully!")
```

è¿è¡Œ python ä»£ç ï¼Œè§‚å¯Ÿ alertgateway æ§åˆ¶å°

<img src="/img/image-20241231173525562.png" alt="image-20241231173525562" style="zoom:80%;" />

**API æ¨é€**

è¿˜å¯ä»¥ä½¿ç”¨Prometheusæ–‡æœ¬åè®®æ¨é€æŒ‡æ ‡ï¼Œæ— éœ€å€ŸåŠ©å•ç‹¬çš„CLIï¼Œåªéœ€è¦curlä¹‹ç±»çš„å·¥å…·å³å¯ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æ–‡æœ¬ä¸­å¿…é¡»åŒ…å«("LF"æˆ–è€…"\n")æ¥ç»“å°¾ï¼Œä»¥å…¶ä»–æ–¹å¼ç»“æŸä¸€è¡Œï¼Œä¾‹å¦‚ï¼š"CR" ('r')ï¼Œ'CRLF' ('\r\n')æˆ–è€…åªæ˜¯æ•°æ®åŒ…ç»“å°¾ï¼Œå°†å¯¼è‡´åè®®é”™è¯¯

echo "some_metrics 3.14" | curl --data-binary @- http://10.0.0.21:9091/metrics/job/web_requests

è¿™é‡Œæ˜¯å°†æ•°æ®æ ·æœ¬æ¨é€åˆ°äº†jobåä¸ºweb_requestsçš„æ ‡è¯†ç»„ä¸­

<img src="/img/image-20241231173930950.png" alt="image-20241231173930950" style="zoom:80%;" />

æ¥ä¸‹æ¥æˆ‘ä»¬æ¨é€ä¸€ä¸ªæ›´éº»çƒ¦ç‚¹çš„

```
cat <<EOF | curl --data-binary @- http://10.0.0.21:9091/metrics/job/web_requests/instance/web
# TYPE some_metric counter
some_metrics{label="vall"} 22
# TYPE another_metric gauge
# HELP another_metric Just an example.
another_metric 2991.132
EOF
```

<img src="/img/image-20241231175220092.png" alt="image-20241231175220092" style="zoom:80%;" />

å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶æ˜¯åŒä¸€ä¸ªjobä½†æ˜¯instanceæ˜¯ä¸åŒçš„ï¼Œè¿™ä¸ªæ—¶å€™ä»–ä»¬çš„æ•°æ®æ˜¯ä¸åœ¨ä¸€èµ·å±•ç¤ºçš„

åˆ é™¤æŒ‡æ ‡ä¹Ÿéå¸¸çš„ç®€å•ï¼Œè¿™ä¸ªæ—¶å€™å°±ä½¿ç”¨åˆ°æˆ‘ä»¬çš„HTTP åè®®ä¸­çš„DELETEäº†ï¼Œæˆ‘ä»¬æ¥åˆ é™¤åˆšåˆšåˆ›å»ºçš„ä¸€ä¸ªåˆ†ç»„

curl -X DELETE http://10.0.0.21:9091/metrics/job/web_requests/instance/web

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„åˆ é™¤æ˜¯æ ¹æ®åˆ†ç»„æ ‡è¯†è¿›è¡Œåˆ é™¤çš„æ¯”å¦‚åˆ é™¤{job="web_requests"}ä¸‹çš„æ‰€æœ‰æŒ‡æ ‡

**æŠ“å–ç›®æ ‡**

ä¿®æ”¹ prometheus çš„é…ç½®æ–‡ä»¶ï¼Œå‘ç°æœåŠ¡ï¼Œéšåé‡å¯ prometheus

<img src="/img/image-20250101204242892.png" alt="image-20250101204242892" style="zoom:80%;" />

PromQLæ¥æŸ¥è¯¢æˆ‘ä»¬çš„æ¨é€ä¸Šå»çš„è¯­å¥
PromQLï¼šsome_metrics{job=~'pushgateway'}

å®¢è§‚æ¥è®²æˆ‘ä»¬çš„ç”Ÿäº§ä¸­èƒ½ä¸ä½¿ç”¨è¿™ä¸ªå°±å°½é‡ä¸è¦ä½¿ç”¨è¿™ä¸ª pushgateway

 <img src="/img/image-20250101204611257.png" alt="image-20250101204611257" style="zoom:80%;" />

### AlertManager

å‰é¢æˆ‘ä»¬å­¦ä¹ äº†Prometheusçš„æ—¶å€™äº†è§£åˆ°äº†PrometheusåŒ…å«ä¸€ä¸ªå‘Šè­¦æ¨¡å—ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©æ¥å­¦çš„AlertManagerï¼ŒAlertmanagerä¸»è¦ç”¨äºæ¥æ”¶Prometheuså‘é€çš„å‘Šè­¦ä¿¡æ¯ï¼Œå®ƒæ”¯æŒä¸°å¯Œçš„å‘Šè­¦é€šçŸ¥æ¸ é“ï¼Œè€Œä¸”å¾ˆå®¹æ˜“åšåˆ°å‘Šè­¦ä¿¡æ¯å»é‡ï¼Œé™å™ªï¼Œåˆ†ç»„ç­‰ï¼Œæ˜¯ä¸€æ¬¾éå¸¸å‰å«çš„å‘Šè­¦ç³»ç»Ÿ

é€šè¿‡åœ¨Prometheusä¸­å®šä¹‰å‘Šè­¦è§„åˆ™ï¼ŒPrometheusä¼šå‘¨æœŸæ€§çš„å¯¹å‘Šè­¦ç­–ç•¥è¿›è¡Œè®¡ç®—ï¼Œå¦‚æœæ»¡è¶³å‘Šè­¦è§¦å‘æ¡ä»¶å°±ä¼šæƒ³Alertmanagerå‘é€å‘Šè­¦ä¿¡æ¯

#### 1.æ¦‚å¿µ

åˆ†ç»„ï¼ˆGroupingï¼‰

Grouping æ˜¯ **Alertmanager** æŠŠåŒç±»å‹çš„è­¦æŠ¥è¿›è¡Œåˆ†ç»„ï¼Œåˆå¹¶å¤šæ¡è­¦æŠ¥åˆ°ä¸€ä¸ªé€šçŸ¥ä¸­ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç‰¹åˆ«æ˜¯äº‘ç¯å¢ƒä¸‹çš„ä¸šåŠ¡ä¹‹é—´å¯†é›†è€¦åˆæ—¶ï¼Œè‹¥å‡ºç°å¤šå° Instance æ•…éšœï¼Œå¯èƒ½ä¼šå¯¼è‡´æˆåƒä¸Šç™¾æ¡è­¦æŠ¥è§¦å‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨åˆ†ç»„æœºåˆ¶ï¼Œå¯ä»¥æŠŠè¿™äº›è¢«è§¦å‘çš„è­¦æŠ¥åˆå¹¶ä¸ºä¸€ä¸ªè­¦æŠ¥è¿›è¡Œé€šçŸ¥ï¼Œä»è€Œé¿å…ç¬é—´çªå‘æ€§çš„æ¥å—å¤§é‡è­¦æŠ¥é€šçŸ¥ï¼Œä½¿å¾—ç®¡ç†å‘˜æ— æ³•å¯¹é—®é¢˜è¿›è¡Œå¿«é€Ÿå®šä½

ä¸¾ä¸ªæ —å­ï¼Œåœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œè¿è¡Œç€é‡é‡çº§è§„æ¨¡çš„å®ä¾‹ï¼Œå³ä¾¿æ˜¯é›†ç¾¤ä¸­æŒç»­å¾ˆå°ä¸€æ®µæ—¶é—´çš„ç½‘ç»œå»¶è¿Ÿæˆ–è€…å»¶è¿Ÿå¯¼è‡´ç½‘ç»œæŠ–åŠ¨ï¼Œä¹Ÿä¼šå¼•å‘å¤§é‡ç±»ä¼¼æœåŠ¡åº”ç”¨æ— æ³•è¿æ¥ DB çš„æ•…éšœã€‚å¦‚æœåœ¨è­¦æŠ¥è§„åˆ™ä¸­å®šä¹‰æ¯ä¸€ä¸ªåº”ç”¨å®ä¾‹éƒ½å‘é€è­¦æŠ¥ï¼Œé‚£ä¹ˆåˆ°æœ€åçš„ç»“æœå°±æ˜¯
ä¼šæœ‰å¤§é‡çš„è­¦æŠ¥ä¿¡æ¯å‘é€ç»™ **Alertmanager**

ä½œä¸ºè¿ç»´ç»„æˆ–è€…ç›¸å…³ä¸šåŠ¡ç»„çš„å¼€å‘äººå‘˜ï¼Œå¯èƒ½æ›´å…³å¿ƒçš„æ˜¯åœ¨ä¸€ä¸ªé€šçŸ¥ä¸­å°±å¯ä»¥å¿«é€ŸæŸ¥çœ‹åˆ°å“ªäº›æœåŠ¡å®ä¾‹è¢«æœ¬æ¬¡æ•…éšœå½±å“äº†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯¹æœåŠ¡æ‰€åœ¨é›†ç¾¤æˆ–è€…æœåŠ¡è­¦æŠ¥åç§°çš„ç»´åº¦è¿›è¡Œåˆ†ç»„é…ç½®ï¼ŒæŠŠè­¦æŠ¥æ±‡æ€»æˆä¸€æ¡é€šçŸ¥æ—¶ï¼Œå°±ä¸ä¼šå—åˆ°è­¦æŠ¥ä¿¡æ¯çš„é¢‘ç¹å‘é€å½±å“äº†

æŠ‘åˆ¶ï¼ˆInhibitionï¼‰

Inhibition æ˜¯ å½“æŸæ¡è­¦æŠ¥å·²ç»å‘é€ï¼Œåœæ­¢é‡å¤å‘é€ç”±æ­¤è­¦æŠ¥å¼•å‘çš„å…¶ä»–å¼‚å¸¸æˆ–æ•…éšœçš„è­¦æŠ¥æœºåˆ¶

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒIDCæ‰˜ç®¡æœºæŸœä¸­ï¼Œè‹¥æ¯ä¸€ä¸ªæœºæŸœæ¥å…¥å±‚ä»…ä»…æ˜¯å•å°äº¤æ¢æœºï¼Œé‚£ä¹ˆè¯¥æœºæŸœæ¥å…¥äº¤æ¢æœºæ•…éšœä¼šé€ æˆæœºæŸœä¸­æœåŠ¡å™¨é up çŠ¶æ€è­¦æŠ¥ã€‚å†æœ‰æœåŠ¡å™¨ä¸Šéƒ¨ç½²çš„åº”ç”¨æœåŠ¡ä¸å¯è®¿é—®ä¹Ÿä¼šè§¦å‘è­¦æŠ¥

è¿™æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡åœ¨ **Alertmanager** é…ç½®å¿½ç•¥ç”±äºäº¤æ¢æœºæ•…éšœè€Œé€ æˆçš„æ­¤æœºæŸœä¸­çš„æ‰€æœ‰æœåŠ¡å™¨åŠå…¶åº”ç”¨ä¸å¯è¾¾è€Œäº§ç”Ÿçš„è­¦æŠ¥

åœ¨æˆ‘ä»¬çš„ç¾å¤‡ä½“ç³»ä¸­ï¼Œå½“åŸæœ‰é›†ç¾¤æ•…éšœå®•æœºä¸šåŠ¡å½»åº•æ— æ³•è®¿é—®çš„æ—¶å€™ï¼Œä¼šæŠŠç”¨æˆ·æµé‡åˆ‡æ¢åˆ°å¤‡ä»½é›†ç¾¤ä¸­ï¼Œè¿™æ ·ä¸ºæ•…éšœé›†ç¾¤åŠå…¶æä¾›çš„å„ä¸ªå¾®æœåŠ¡çŠ¶æ€å‘é€è­¦æŠ¥æœºä¼šå¤±å»äº†æ„ä¹‰ï¼Œæ­¤æ—¶ï¼Œ **Alertmanager** çš„æŠ‘åˆ¶ç‰¹æ€§å°±å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…ç®¡ç†å‘˜æ”¶åˆ°è¿‡å¤šæ— ç”¨çš„è­¦æŠ¥é€šçŸ¥

é™é»˜ï¼ˆSilences ï¼‰

Silences æä¾›äº†ä¸€ä¸ªç®€å•çš„æœºåˆ¶ï¼Œæ ¹æ®æ ‡ç­¾å¿«é€Ÿå¯¹è­¦æŠ¥è¿›è¡Œé™é»˜å¤„ç†ï¼›å¯¹ä¼ è¿›æ¥çš„è­¦æŠ¥è¿›è¡ŒåŒ¹é…æ£€æŸ¥ï¼Œå¦‚æœæ¥å—åˆ°è­¦æŠ¥ç¬¦åˆé™é»˜çš„é…ç½®ï¼Œ**Alertmanager** åˆ™ä¸ä¼šå‘é€è­¦æŠ¥é€šçŸ¥

ä»¥ä¸Šé™¤äº†åˆ†ç»„ã€æŠ‘åˆ¶æ˜¯åœ¨ **Alertmanager** é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œé™é»˜æ˜¯éœ€è¦åœ¨ WEB UI ç•Œé¢ä¸­è®¾ç½®ä¸´æ—¶å±è”½æŒ‡å®šçš„è­¦æŠ¥é€šçŸ¥

è·¯ç”±ï¼ˆrouteï¼‰

ç”¨äºé…ç½® Alertmanager å¦‚ä½•å¤„ç†ä¼ å…¥çš„ç‰¹å®šç±»å‹çš„å‘Šè­¦é€šçŸ¥ï¼Œå…¶åŸºæœ¬é€»è¾‘æ˜¯æ ¹æ®è·¯ç”±åŒ¹é…è§„åˆ™çš„åŒ¹é…ç»“æœæ¥ç¡®å®šå¤„ç†å½“å‰æŠ¥è­¦é€šçŸ¥çš„è·¯å¾„å’Œè¡Œä¸º

#### 2.é…ç½®è¯¦è§£

```yaml
global:
  # ç»è¿‡æ­¤æ—¶é—´åï¼Œå¦‚æœå°šæœªæ›´æ–°å‘Šè­¦ï¼Œåˆ™å°†å‘Šè­¦å£°æ˜ä¸ºå·²æ¢å¤ã€‚(å³prometheusæ²¡æœ‰å‘alertmanagerå‘é€å‘Šè­¦äº†)
  resolve_timeout: 5m
  # é…ç½®å‘é€é‚®ä»¶ä¿¡æ¯
  smtp_smarthost: 'smtp.qq.com:465'
  smtp_from: '742899387@qq.com'
  smtp_auth_username: '742899387@qq.com'
  smtp_auth_password: 'password'
  smtp_require_tls: false

# è¯»å–å‘Šè­¦é€šçŸ¥æ¨¡æ¿çš„ç›®å½•ã€‚
templates:
- '/etc/alertmanager/template/*.tmpl'

# æ‰€æœ‰æŠ¥è­¦éƒ½ä¼šè¿›å…¥åˆ°è¿™ä¸ªæ ¹è·¯ç”±ä¸‹ï¼Œå¯ä»¥æ ¹æ®æ ¹è·¯ç”±ä¸‹çš„å­è·¯ç”±è®¾ç½®æŠ¥è­¦åˆ†å‘ç­–ç•¥
route:
  # å…ˆè§£é‡Šä¸€ä¸‹åˆ†ç»„ï¼Œåˆ†ç»„å°±æ˜¯å°†å¤šæ¡å‘Šè­¦ä¿¡æ¯èšåˆæˆä¸€æ¡å‘é€ï¼Œè¿™æ ·å°±ä¸ä¼šæ”¶åˆ°è¿ç»­çš„æŠ¥è­¦äº†ã€‚
  # å°†ä¼ å…¥çš„å‘Šè­¦æŒ‰æ ‡ç­¾åˆ†ç»„(æ ‡ç­¾åœ¨prometheusä¸­çš„rulesä¸­å®šä¹‰)ï¼Œä¾‹å¦‚ï¼š
  # æ¥æ”¶åˆ°çš„å‘Šè­¦ä¿¡æ¯é‡Œé¢æœ‰è®¸å¤šå…·æœ‰cluster=A å’Œ alertname=LatencyHighçš„æ ‡ç­¾ï¼Œè¿™äº›ä¸ªå‘Šè­¦å°†è¢«åˆ†ä¸ºä¸€ä¸ªç»„ã€‚
  # å¦‚æœä¸æƒ³ä½¿ç”¨åˆ†ç»„ï¼Œå¯ä»¥è¿™æ ·å†™group_by: [...]
  group_by: ['alertname', 'cluster', 'service']
  # ç¬¬ä¸€ç»„å‘Šè­¦å‘é€é€šçŸ¥éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸ºåŒä¸€åˆ†ç»„è·å–å¤šä¸ªå‘Šè­¦ï¼Œç„¶åä¸€èµ·è§¦å‘è¿™ä¸ªå‘Šè­¦ä¿¡æ¯ã€‚
  group_wait: 30s
  # å‘é€ç¬¬ä¸€ä¸ªå‘Šè­¦åï¼Œç­‰å¾…"group_interval"å‘é€ä¸€ç»„æ–°å‘Šè­¦ã€‚
  group_interval: 5m
  # åˆ†ç»„å†…å‘é€ç›¸åŒå‘Šè­¦çš„æ—¶é—´é—´éš”ã€‚è¿™é‡Œçš„é…ç½®æ˜¯æ¯3å°æ—¶å‘é€å‘Šè­¦åˆ°åˆ†ç»„ä¸­ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæ”¶åˆ°å‘Šè­¦åï¼Œä¸€ä¸ªåˆ†ç»„è¢«åˆ›å»ºï¼Œç­‰å¾…5åˆ†é’Ÿå‘é€ç»„å†…å‘Šè­¦ï¼Œå¦‚æœåç»­ç»„å†…çš„å‘Šè­¦ä¿¡æ¯ç›¸åŒ,è¿™äº›å‘Šè­¦ä¼šåœ¨3å°æ—¶åå‘é€ï¼Œä½†æ˜¯3å°æ—¶å†…è¿™äº›å‘Šè­¦ä¸ä¼šè¢«å‘é€ã€‚
  repeat_interval: 3h
  # è¿™é‡Œå…ˆè¯´ä¸€ä¸‹ï¼Œå‘Šè­¦å‘é€æ˜¯éœ€è¦æŒ‡å®šæ¥æ”¶å™¨çš„ï¼Œæ¥æ”¶å™¨åœ¨receiversä¸­é…ç½®ï¼Œæ¥æ”¶å™¨å¯ä»¥æ˜¯emailã€webhookã€pagerdutyã€wechatç­‰ç­‰ã€‚ä¸€ä¸ªæ¥æ”¶å™¨å¯ä»¥æœ‰å¤šç§å‘é€æ–¹å¼ã€‚
  # æŒ‡å®šé»˜è®¤çš„æ¥æ”¶å™¨
  receiver: team-X-mails
  # ä¸‹é¢é…ç½®çš„æ˜¯å­è·¯ç”±ï¼Œå­è·¯ç”±çš„å±æ€§ç»§æ‰¿äºæ ¹è·¯ç”±(å³ä¸Šé¢çš„é…ç½®)ï¼Œåœ¨å­è·¯ç”±ä¸­å¯ä»¥è¦†ç›–æ ¹è·¯ç”±çš„é…ç½®
  # ä¸‹é¢æ˜¯å­è·¯ç”±çš„é…ç½®
  routes:
  # ä½¿ç”¨æ­£åˆ™çš„æ–¹å¼åŒ¹é…å‘Šè­¦æ ‡ç­¾
  - match_re:
      # è¿™é‡Œå¯ä»¥åŒ¹é…å‡ºæ ‡ç­¾å«æœ‰service=foo1æˆ–service=foo2æˆ–service=bazçš„å‘Šè­¦
      service: ^(foo1|foo2|baz)$
    # æŒ‡å®šæ¥æ”¶å™¨ä¸ºteam-X-mails
    receiver: team-X-mails
    # è¿™é‡Œé…ç½®çš„æ˜¯å­è·¯ç”±çš„å­è·¯ç”±ï¼Œå½“æ»¡è¶³çˆ¶è·¯ç”±çš„çš„åŒ¹é…æ—¶ï¼Œè¿™æ¡å­è·¯ç”±ä¼šè¿›ä¸€æ­¥åŒ¹é…å‡ºseverity=criticalçš„å‘Šè­¦ï¼Œå¹¶ä½¿ç”¨team-X-pageræ¥æ”¶å™¨å‘é€å‘Šè­¦ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„å‘Šè­¦ä¼šç”±çˆ¶è·¯ç”±è¿›è¡Œå¤„ç†ã€‚
    routes:
    - match:
        severity: critical
      receiver: team-X-pager

  # è¿™é‡Œä¹Ÿæ˜¯ä¸€æ¡å­è·¯ç”±ï¼Œä¼šåŒ¹é…å‡ºæ ‡ç­¾å«æœ‰service=filesçš„å‘Šè­¦ï¼Œå¹¶ä½¿ç”¨team-Y-mailsæ¥æ”¶å™¨å‘é€å‘Šè­¦
  - match:
      service: files
    receiver: team-Y-mails
    # è¿™é‡Œé…ç½®çš„æ˜¯å­è·¯ç”±çš„å­è·¯ç”±ï¼Œå½“æ»¡è¶³çˆ¶è·¯ç”±çš„çš„åŒ¹é…æ—¶ï¼Œè¿™æ¡å­è·¯ç”±ä¼šè¿›ä¸€æ­¥åŒ¹é…å‡ºseverity=criticalçš„å‘Šè­¦ï¼Œå¹¶ä½¿ç”¨team-Y-pageræ¥æ”¶å™¨å‘é€å‘Šè­¦ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„ä¼šç”±çˆ¶è·¯ç”±è¿›è¡Œå¤„ç†ã€‚
    routes:
    - match:
        severity: critical
      receiver: team-Y-pager

  # è¯¥è·¯ç”±å¤„ç†æ¥è‡ªæ•°æ®åº“æœåŠ¡çš„æ‰€æœ‰è­¦æŠ¥ã€‚å¦‚æœæ²¡æœ‰å›¢é˜Ÿæ¥å¤„ç†ï¼Œåˆ™é»˜è®¤ä¸ºæ•°æ®åº“å›¢é˜Ÿã€‚
  - match:
      # é¦–å…ˆåŒ¹é…æ ‡ç­¾service=database
      service: database
    # æŒ‡å®šæ¥æ”¶å™¨
    receiver: team-DB-pager
    # æ ¹æ®å—å½±å“çš„æ•°æ®åº“å¯¹å‘Šè­¦è¿›è¡Œåˆ†ç»„
    group_by: [alertname, cluster, database]
    routes:
    - match:
        owner: team-X
      receiver: team-X-pager
      # å‘Šè­¦æ˜¯å¦ç»§ç»­åŒ¹é…åç»­çš„åŒçº§è·¯ç”±èŠ‚ç‚¹ï¼Œé»˜è®¤falseï¼Œä¸‹é¢å¦‚æœä¹Ÿå¯ä»¥åŒ¹é…æˆåŠŸï¼Œä¼šå‘ä¸¤ç§æ¥æ”¶å™¨éƒ½å‘é€å‘Šè­¦ä¿¡æ¯(çŒœæµ‹ã€‚ã€‚ã€‚)
      continue: true
    - match:
        owner: team-Y
      receiver: team-Y-pager


# ä¸‹é¢æ˜¯å…³äºinhibit(æŠ‘åˆ¶)çš„é…ç½®ï¼Œå…ˆè¯´ä¸€ä¸‹æŠ‘åˆ¶æ˜¯ä»€ä¹ˆï¼šæŠ‘åˆ¶è§„åˆ™å…è®¸åœ¨å¦ä¸€ä¸ªè­¦æŠ¥æ­£åœ¨è§¦å‘çš„æƒ…å†µä¸‹ä½¿ä¸€ç»„å‘Šè­¦é™éŸ³ã€‚å…¶å®å¯ä»¥ç†è§£ä¸ºå‘Šè­¦ä¾èµ–ã€‚æ¯”å¦‚ä¸€å°æ•°æ®åº“æœåŠ¡å™¨æ‰ç”µäº†ï¼Œä¼šå¯¼è‡´dbç›‘æ§å‘Šè­¦ã€ç½‘ç»œå‘Šè­¦ç­‰ç­‰ï¼Œå¯ä»¥é…ç½®æŠ‘åˆ¶è§„åˆ™å¦‚æœæœåŠ¡å™¨æœ¬èº«downäº†ï¼Œé‚£ä¹ˆå…¶ä»–çš„æŠ¥è­¦å°±ä¸ä¼šè¢«å‘é€å‡ºæ¥ã€‚

inhibit_rules:
#ä¸‹é¢é…ç½®çš„å«ä¹‰ï¼šå½“æœ‰å¤šæ¡å‘Šè­¦åœ¨å‘Šè­¦ç»„é‡Œæ—¶ï¼Œå¹¶ä¸”ä»–ä»¬çš„æ ‡ç­¾alertname,cluster,serviceéƒ½ç›¸ç­‰ï¼Œå¦‚æœseverity: 'critical'çš„å‘Šè­¦äº§ç”Ÿäº†ï¼Œé‚£ä¹ˆå°±ä¼šæŠ‘åˆ¶severity: 'warning'çš„å‘Šè­¦ã€‚
- source_match:  # æºå‘Šè­¦(æˆ‘ç†è§£æ˜¯æ ¹æ®è¿™ä¸ªæŠ¥è­¦æ¥æŠ‘åˆ¶target_matchä¸­åŒ¹é…çš„å‘Šè­¦)
    severity: 'critical' # æ ‡ç­¾åŒ¹é…æ»¡è¶³severity=criticalçš„å‘Šè­¦ä½œä¸ºæºå‘Šè­¦
  target_match:  # ç›®æ ‡å‘Šè­¦(è¢«æŠ‘åˆ¶çš„å‘Šè­¦)
    severity: 'warning'  # å‘Šè­¦å¿…é¡»æ»¡è¶³æ ‡ç­¾åŒ¹é…severity=warningæ‰ä¼šè¢«æŠ‘åˆ¶ã€‚
  equal: ['alertname', 'cluster', 'service']  # å¿…é¡»åœ¨æºå‘Šè­¦å’Œç›®æ ‡å‘Šè­¦ä¸­å…·æœ‰ç›¸ç­‰å€¼çš„æ ‡ç­¾æ‰èƒ½ä½¿æŠ‘åˆ¶ç”Ÿæ•ˆã€‚(å³æºå‘Šè­¦å’Œç›®æ ‡å‘Šè­¦ä¸­è¿™ä¸‰ä¸ªæ ‡ç­¾çš„å€¼ç›¸ç­‰'alertname', 'cluster', 'service')


# ä¸‹é¢é…ç½®çš„æ˜¯æ¥æ”¶å™¨
receivers:
# æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡é‚®ä»¶çš„æ–¹å¼å‘é€ã€
- name: 'team-X-mails'
  email_configs:
    # å‘é€ç»™å“ªäº›äºº
  - to: 'team-X+alerts@example.org'
    # æ˜¯å¦é€šçŸ¥å·²è§£å†³çš„è­¦æŠ¥
    send_resolved: true

# æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡é‚®ä»¶å’Œpagerdutyçš„æ–¹å¼å‘é€ã€å‘é€ç»™å“ªäº›äººï¼ŒæŒ‡å®špagerdutyçš„service_key
- name: 'team-X-pager'
  email_configs:
  - to: 'team-X+alerts-critical@example.org'
  pagerduty_configs:
  - service_key: <team-X-key>

# æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡é‚®ä»¶çš„æ–¹å¼å‘é€ã€å‘é€ç»™å“ªäº›äºº
- name: 'team-Y-mails'
  email_configs:
  - to: 'team-Y+alerts@example.org'

# æ¥æ”¶å™¨çš„åç§°ã€é€šè¿‡pagerdutyçš„æ–¹å¼å‘é€ã€æŒ‡å®špagerdutyçš„service_key
- name: 'team-Y-pager'
  pagerduty_configs:
  - service_key: <team-Y-key>

# ä¸€ä¸ªæ¥æ”¶å™¨é…ç½®å¤šç§å‘é€æ–¹å¼
- name: 'ops'
  webhook_configs:
  - url: 'http://prometheus-webhook-dingtalk.kube-ops.svc.cluster.local:8060/dingtalk/webhook1/send'
    send_resolved: true
  email_configs:
  - to: '742899387@qq.com'
    send_resolved: true
  - to: 'soulchild@soulchild.cn'
    send_resolved: true
```

å®é™…é…ç½®ç¤ºä¾‹

```yaml
## Alertmanager é…ç½®æ–‡ä»¶
global:
  resolve_timeout: 5m
  # smtpé…ç½®
  smtp_from: "123456789@qq.com"
  smtp_smarthost: 'smtp.qq.com:465'
  smtp_auth_username: "123456789@qq.com"
  smtp_auth_password: "auth_pass"
  smtp_require_tls: true
# emailã€ä¼ä¸šå¾®ä¿¡çš„æ¨¡æ¿é…ç½®å­˜æ”¾ä½ç½®ï¼Œé’‰é’‰çš„æ¨¡æ¿ä¼šå•ç‹¬è®²å¦‚æœé…ç½®ã€‚
templates:
  - '/data/alertmanager/templates/*.tmpl'
# è·¯ç”±åˆ†ç»„
route:
  receiver: ops
  group_wait: 30s # åœ¨ç»„å†…ç­‰å¾…æ‰€é…ç½®çš„æ—¶é—´ï¼Œå¦‚æœåŒç»„å†…ï¼Œ30ç§’å†…å‡ºç°ç›¸åŒæŠ¥è­¦ï¼Œåœ¨ä¸€ä¸ªç»„å†…å‡ºç°ã€‚
  group_interval: 5m # å¦‚æœç»„å†…å†…å®¹ä¸å˜åŒ–ï¼Œåˆå¹¶ä¸ºä¸€æ¡è­¦æŠ¥ä¿¡æ¯ï¼Œ5måå‘é€ã€‚
  repeat_interval: 24h # å‘é€æŠ¥è­¦é—´éš”ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä¿®å¤ï¼Œåˆ™é‡æ–°å‘é€æŠ¥è­¦ã€‚
  group_by: [alertname]  # æŠ¥è­¦åˆ†ç»„
  routes:
      - match:
          team: operations
        group_by: [env,dc]
        receiver: 'ops'
      - match_re:
          service: nginx|apache
        receiver: 'web'
      - match_re:
          service: hbase|spark
        receiver: 'hadoop'
      - match_re:
          service: mysql|mongodb
        receiver: 'db'
# æ¥æ”¶å™¨
# æŠ‘åˆ¶æµ‹è¯•é…ç½®
      - receiver: ops
        group_wait: 10s
        match:
          status: 'High'
# ops
      - receiver: ops # è·¯ç”±å’Œæ ‡ç­¾ï¼Œæ ¹æ®matchæ¥æŒ‡å®šå‘é€ç›®æ ‡ï¼Œå¦‚æœ ruleçš„lable åŒ…å« alertnameï¼Œ ä½¿ç”¨ ops æ¥å‘é€
        group_wait: 10s
        match:
          team: operations
# web
      - receiver: db # è·¯ç”±å’Œæ ‡ç­¾ï¼Œæ ¹æ®matchæ¥æŒ‡å®šå‘é€ç›®æ ‡ï¼Œå¦‚æœ ruleçš„lable åŒ…å« alertnameï¼Œ ä½¿ç”¨ db æ¥å‘é€
        group_wait: 10s
        match:
          team: db
# æ¥æ”¶å™¨æŒ‡å®šå‘é€äººä»¥åŠå‘é€æ¸ é“
receivers:
# opsåˆ†ç»„çš„å®šä¹‰
- name: ops
  email_configs:
  - to: '9935226@qq.com,10000@qq.com'
    send_resolved: true
    headers:
      subject: "[operations] æŠ¥è­¦é‚®ä»¶"
      from: "è­¦æŠ¥ä¸­å¿ƒ"
      to: "å°ç…œç‹¼çš‡"
  # é’‰é’‰é…ç½®
  webhook_configs:
  - url: http://localhost:8070/dingtalk/ops/send
    # ä¼ä¸šå¾®ä¿¡é…ç½®
  wechat_configs:
  - corp_id: 'ww5421dksajhdasjkhj'
    api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
    send_resolved: true
    to_party: '2'
    agent_id: '1000002'
    api_secret: 'Tm1kkEE3RGqVhv5hO-khdakjsdkjsahjkdksahjkdsahkj'

# web
- name: web
  email_configs:
  - to: '9935226@qq.com'
    send_resolved: true
    headers: { Subject: "[web] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  webhook_configs:
  - url: http://localhost:8070/dingtalk/web/send
  - url: http://localhost:8070/dingtalk/ops/send
# db
- name: db
  email_configs:
  - to: '9935226@qq.com'
    send_resolved: true
    headers: { Subject: "[db] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  webhook_configs:
  - url: http://localhost:8070/dingtalk/db/send
  - url: http://localhost:8070/dingtalk/ops/send
# hadoop
- name: hadoop
  email_configs:
  - to: '9935226@qq.com'
    send_resolved: true
    headers: { Subject: "[hadoop] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  webhook_configs:
  - url: http://localhost:8070/dingtalk/hadoop/send
  - url: http://localhost:8070/dingtalk/ops/send

# æŠ‘åˆ¶å™¨é…ç½®
inhibit_rules: # æŠ‘åˆ¶è§„åˆ™
  - source_match: # æºæ ‡ç­¾è­¦æŠ¥è§¦å‘æ—¶æŠ‘åˆ¶å«æœ‰ç›®æ ‡æ ‡ç­¾çš„è­¦æŠ¥ï¼Œåœ¨å½“å‰è­¦æŠ¥åŒ¹é… status: 'High'
      status: 'High'  # æ­¤å¤„çš„æŠ‘åˆ¶åŒ¹é…ä¸€å®šåœ¨æœ€ä¸Šé¢çš„routeä¸­é…ç½®ä¸ç„¶ï¼Œä¼šæç¤ºæ‰¾ä¸keyã€‚
    target_match:
      status: 'Warning' # ç›®æ ‡æ ‡ç­¾å€¼æ­£åˆ™åŒ¹é…ï¼Œå¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼å¦‚: ".*MySQL.*"
    equal: ['alertname','operations', 'instance'] # ç¡®ä¿è¿™ä¸ªé…ç½®ä¸‹çš„æ ‡ç­¾å†…å®¹ç›¸åŒæ‰ä¼šæŠ‘åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è­¦æŠ¥ä¸­å¿…é¡»æœ‰è¿™ä¸‰ä¸ªæ ‡ç­¾å€¼æ‰ä¼šè¢«æŠ‘åˆ¶ã€‚
```

**global**

ä¸ºå…¨å±€è®¾ç½®ï¼Œåœ¨ **Alertmanager** é…ç½®æ–‡ä»¶ä¸­ï¼Œåªè¦å…¨å±€è®¾ç½®é…ç½®äº†çš„é€‰é¡¹ï¼Œå…¨éƒ¨ä¸ºå…¬å…±è®¾ç½®ï¼Œå¯ä»¥è®©å…¶ä»–è®¾ç½®ç»§æ‰¿ï¼Œä½œä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥å­å‚æ•°ä¸­è¦†ç›–å…¶è®¾ç½®ã€‚å…¶ä¸­ resolve_timeout ç”¨äºè®¾ç½®å¤„ç†è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿæ˜¯ç”Ÿå‘½è­¦æŠ¥çŠ¶æ€ä¸ºè§£å†³çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ä¼šç›´æ¥å½±å“åˆ°è­¦æŠ¥æ¢å¤çš„é€šçŸ¥æ—¶é—´ï¼Œéœ€è¦è‡ªè¡Œç»“åˆå®é™…ç”Ÿäº§åœºæ™¯æ¥è®¾ç½®ä¸»æœºçš„æ¢å¤æ—¶é—´ï¼Œé»˜è®¤æ˜¯5åˆ†é’Ÿã€‚åœ¨å…¨å±€è®¾ç½®ä¸­å¯ä»¥è®¾ç½®smtpæœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒslackã€victoropsã€pagerdutyç­‰ï¼Œåœ¨è¿™é‡Œåªè®²æˆ‘ä»¬å¸¸ç”¨çš„Emailï¼Œé’‰é’‰ï¼Œä¼ä¸šå¾®ä¿¡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è‡ªå·±ä½¿ç”¨goè¯­è¨€å¼€å‘çš„gubotè¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œå¯¹æ¥è‡ªå®šä¹‰webhooké€šçŸ¥æº

**template**

è­¦æŠ¥æ¨¡æ¿å¯ä»¥è‡ªå®šä¹‰é€šçŸ¥çš„ä¿¡æ¯æ ¼å¼ï¼Œä»¥åŠå…¶åŒ…å«çš„å¯¹åº”è­¦æŠ¥æŒ‡æ ‡æ•°æ®ï¼Œå¯ä»¥è‡ªå®šä¹‰Emailã€ä¼ä¸šå¾®ä¿¡çš„æ¨¡æ¿ï¼Œé…ç½®æŒ‡å®šçš„å­˜æ”¾ä½ç½®ï¼Œå¯¹äºé’‰é’‰çš„æ¨¡æ¿ä¼šå•ç‹¬è®²å¦‚ä½•é…ç½®ï¼Œè¿™é‡Œçš„æ¨¡æ¿æ˜¯æŒ‡çš„å‘é€çš„é€šçŸ¥æºä¿¡æ¯æ ¼å¼æ¨¡æ¿ï¼Œæ¯”å¦‚Emailï¼Œä¼ä¸šå¾®ä¿¡

**route**

è­¦æŠ¥è·¯ç”±æ¨¡å—æè¿°äº†åœ¨æ”¶åˆ° **Prometheus** ç”Ÿæˆçš„è­¦æŠ¥åï¼Œå°†è­¦æŠ¥ä¿¡æ¯å‘é€ç»™æ¥æ”¶å™¨ receiver æŒ‡å®šçš„ç›®æ ‡åœ°å€è§„åˆ™ã€‚ **Alertmanager** å¯¹ä¼ å…¥çš„è­¦æŠ¥ä¿¡æ¯è¿›è¡Œå¤„ç†ï¼Œæ ¹æ®æ‰€å®šä¹‰çš„è§„åˆ™ä¸é…ç½®è¿›è¡ŒåŒ¹é…ã€‚å¯¹äºè·¯ç”±å¯ä»¥ç†è§£ä¸ºæ ‘çŠ¶ç»“æ„ï¼Œè®¾ç½®çš„ç¬¬ä¸€ä¸ªrouteæ˜¯è·ŸèŠ‚ç‚¹ï¼Œå¾€ä¸‹çš„å°±æ˜¯åŒ…å«çš„å­èŠ‚ç‚¹ï¼Œæ¯ä¸ªè­¦æŠ¥ä¼ è¿›æ¥ä»¥åï¼Œä¼šä»é…ç½®çš„è·ŸèŠ‚ç‚¹è·¯ç”±è¿›å…¥è·¯ç”±æ ‘ï¼ŒæŒ‰ç…§æ·±åº¦ä¼˜å…ˆä»å·¦å‘å³éå†åŒ¹é…ï¼Œå½“åŒ¹é…çš„èŠ‚ç‚¹ååœæ­¢ï¼Œè¿›è¡Œè­¦æŠ¥å¤„ç†

| å‚æ•°                                      | æè¿°                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| receiver: \<string>                       | å‘é€è­¦æŠ¥çš„æ¥æ”¶å™¨åç§°                                         |
| group_by: ['label_name1,...']             | æ ¹æ® prometheus çš„ lables è¿›è¡ŒæŠ¥è­¦åˆ†ç»„ï¼Œè¿™äº›è­¦æŠ¥ä¼šåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥å‘é€ç»™æ¥æ”¶å™¨ï¼Œä¹Ÿå°±æ˜¯è­¦æŠ¥åˆ†ç»„ |
| match: [ <label_name>: \<labelvalue>,...] | é€šè¿‡æ­¤è®¾ç½®æ¥åˆ¤æ–­å½“å‰è­¦æŠ¥ä¸­æ˜¯å¦æœ‰æ ‡ç­¾çš„labelnameï¼Œç­‰åŒäºlabelvalue |
| match_re: [<label_name>: \<regex>,...]    | é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè­¦æŠ¥é…ç½®                                   |
| group_wait: [\<duration>]                 | è®¾ç½®ä»æ¥å—è­¦æŠ¥åˆ°å‘é€çš„ç­‰å¾…æ—¶é—´ï¼Œè‹¥åœ¨ç­‰å¾…æ—¶é—´ä¸­groupæ¥æ”¶åˆ°æ–°çš„è­¦æŠ¥ä¿¡æ¯ï¼Œè¿™äº›è­¦æŠ¥ä¼šåˆå¹¶ä¸ºä¸€æ¡å‘é€ï¼Œé»˜è®¤30s |
| group_interval: [\<duration>]             | æ­¤è®¾ç½®æ§åˆ¶çš„æ˜¯ group ä¹‹é—´å‘é€è­¦æŠ¥é€šçŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤5m      |
| repeat_interval: [\<duration>]            | æ­¤è®¾ç½®æ§åˆ¶çš„æ˜¯è­¦æŠ¥å‘é€æˆåŠŸä»¥åï¼Œæ²¡æœ‰å¯¹è­¦æŠ¥åšè§£å†³æ“ä½œçš„è¯ï¼ŒçŠ¶æ€ Firing æ²¡æœ‰å˜æˆ Inactive æˆ–è€… Pending ï¼Œä¼šå†æ¬¡å‘é€è­¦æŠ¥çš„çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤4h |
| routes: - \<route>...                     |                                                              |

è·¯ç”±åŒ¹é…è§„åˆ™ç¤ºä¾‹

```yaml
route:
  receiver: admin # é»˜è®¤çš„æ¥æ”¶å™¨åç§°
  group_wait: 30s # åœ¨ç»„å†…ç­‰å¾…æ‰€é…ç½®çš„æ—¶é—´ï¼Œå¦‚æœåŒç»„å†…ï¼Œ30ç§’å†…å‡ºç°ç›¸åŒæŠ¥è­¦ï¼Œåœ¨ä¸€ä¸ªç»„å†…å‡ºç°ã€‚
  group_interval: 5m # å¦‚æœç»„å†…å†…å®¹ä¸å˜åŒ–ï¼Œ5måå‘é€ã€‚
  repeat_interval: 24h # å‘é€æŠ¥è­¦é—´éš”ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä¿®å¤ï¼Œåˆ™é‡æ–°å‘é€æŠ¥è­¦
  group_by: [alertname,cluster]  # æŠ¥è­¦åˆ†ç»„ï¼Œæ ¹æ® prometheus çš„ lables è¿›è¡ŒæŠ¥è­¦åˆ†ç»„ï¼Œè¿™äº›è­¦æŠ¥ä¼šåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥å‘é€ç»™æ¥æ”¶å™¨ï¼Œä¹Ÿå°±æ˜¯è­¦æŠ¥åˆ†ç»„ã€‚
  routes:
      - match:
          team: ops
        group_by: [env,dc]
        receiver: 'ops'
      - match_re:
          service: nginx|apache
        receiver: 'web'
      - match_re:
          service: mysql|mongodb
        receiver: 'db'
      - match_re:
          service: hbase|spark
        receiver: 'hadoop'
```

åœ¨ä»¥ä¸Šçš„ä¾‹å­ä¸­ï¼Œé»˜è®¤çš„è­¦æŠ¥ç»„å…¨éƒ¨å‘é€ç»™ admin ï¼Œä¸”æ ¹æ®è·¯ç”±æŒ‰ç…§ alertname cluster è¿›è¡Œè­¦æŠ¥åˆ†ç»„ã€‚åœ¨å­è·¯ç”±ä¸­çš„è‹¥åŒ¹é…è­¦æŠ¥ä¸­çš„æ ‡ç­¾ team çš„å€¼ä¸º opsï¼ŒAlertmanager ä¼šæŒ‰ç…§æ ‡ç­¾ env dc è¿›è¡Œè­¦æŠ¥åˆ†ç»„ç„¶åå‘é€ç»™æ¥æ”¶å™¨ receiver opsé…ç½®çš„è­¦æŠ¥é€šçŸ¥æºï¼Œç»§ç»­åŒ¹é…çš„æ“ä½œæ˜¯å¯¹ service æ ‡ç­¾è¿›è¡ŒåŒ¹é…ï¼Œå¹¶ä¸”é…åˆ°äº† nginx redis mongodb çš„å€¼ï¼Œå°±ä¼šå‘æ¥æ”¶å™¨ receiver webé…ç½®çš„è­¦æŠ¥é€šçŸ¥æºå‘é€è­¦æŠ¥ä¿¡æ¯

 å¯¹è¿™ç§åŒ¹é…éªŒè¯æ“ä½œç°å¸¸è€ƒç©¶ä¸ªäººçš„é€»è¾‘æ€ç»´èƒ½åŠ›ï¼Œè¿™ä¸æ˜¯äººå¹²çš„äº‹æƒ…å‘€~å› æ­¤ï¼ŒPrometheuså‘å¸ƒäº†ä¸€ä¸ª [Routing tree editor](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.prometheus.io%2Fwebtools%2Falerting%2Frouting-tree-editor%2F)ï¼Œç”¨äºæ£€æµ‹Alertmanagerçš„é…ç½®æ–‡ä»¶ç»“æ„é…ç½®ä¿¡æ¯ï¼Œç„¶åè°ƒè¯•ã€‚ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠ alertmanager.yml çš„é…ç½®ä¿¡å¿ƒå¤åˆ¶åˆ°è¿™ä¸ªç«™ç‚¹ï¼Œç„¶åç‚¹å‡» Draw Routing Tree æŒ‰é’®ç”Ÿæˆè·¯ç”±ç»“æ„æ ‘ï¼Œç„¶ååœ¨ Match Label Set å‰é¢è¾“å…¥ä»¥ {\<label name> = "\<value>"} æ ¼å¼çš„è­¦æŠ¥æ ‡ç­¾ï¼Œç„¶åç‚¹å‡» Match Label Set æŒ‰é’®ä¼šæ˜¾ç¤ºå‘é€çŠ¶æ€å›¾

https://www.prometheus.io/webtools/alerting/routing-tree-editor/

ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ {service="nginx"} å’Œ {service="mysql"} è¡¨è¾¾å¼æ¥åšåŒ¹é…çš„è§„åˆ™ç”¨äºéªŒè¯å…¶å‘é€é€šçŸ¥æºæ˜¯å¦ä¸º receiver ä¸­ web/db çš„å‘é€é…ç½®

 <img src="/img/image-20250103141338174.png" alt="image-20250103141338174" style="zoom:50%;" />**receiver æ¥æ”¶å™¨**

æ¥å—å™¨æ˜¯ä¸€ä¸ªç»Ÿç§°ï¼Œæ¯ä¸ª receiver éƒ½æœ‰éœ€è¦è®¾ç½®ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åç§°ï¼Œå¹¶ä¸”å¯¹åº”ä¸€ä¸ªæˆ–è€…å¤šä¸ªé€šçŸ¥æ–¹å¼ï¼ŒåŒ…æ‹¬emailã€å¾®ä¿¡ã€Slackã€é’‰é’‰ç­‰

å®˜æ–¹ç°åœ¨æ»¡è¶³çš„é…ç½®æ˜¯ï¼š

```yaml
name: <string>
email_config:
    [ - <config> ]
hipchat_configs: #æ­¤æ¨¡å—é…ç½®å·²ç»è¢«ç§»é™¤äº†
    [ <config> ]
pagerduty_configs:
    [ <config> ]
pushover_configs:
    [ <config> ]
slack_configs:
    [ <config> ]
opsgenie_configs:
    [ <config> ]
webhook_configs:
    [ <config> ]
victorops_configs:
    [ <config> ]
webchat_configs:
    [ <config> ]
```

å¯ä»¥çœ‹åˆ°Alertmanageræä¾›äº†å¾ˆå¤šç§æ¥æ”¶å™¨çš„é€šçŸ¥é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨webhookæ¥æ”¶å™¨æ¥å®šä¹‰é€šçŸ¥é›†æˆï¼Œæ”¯æŒç”¨æˆ·è‡ªå·±å®šä¹‰ç¼–å†™

**inhibit_rules æŠ‘åˆ¶å™¨**

inhibit_rules æ¨¡å—ä¸­è®¾ç½®è­¦æŠ¥æŠ‘åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥æŒ‡å®šåœ¨ç‰¹å®šæ¡ä»¶ä¸‹éœ€è¦å¿½ç•¥çš„è­¦æŠ¥æ¡ä»¶ã€‚å¯ä»¥ä½¿ç”¨æ­¤é€‰é¡¹è®¾ç½®é¦–é€‰ï¼Œæ¯”å¦‚ä¼˜å…ˆå¤„ç†æŸäº›è­¦æŠ¥ï¼Œå¦‚æœåŒä¸€ç»„ä¸­çš„è­¦æŠ¥åŒæ—¶å‘ç”Ÿï¼Œåˆ™å¿½ç•¥å…¶ä»–è­¦æŠ¥ï¼Œåˆç†ä½¿ç”¨ inhibit_rules ï¼Œå¯ä»¥å‡å°‘é¢‘å‘å‘é€æ²¡æœ‰æ„ä¹‰çš„è­¦æŠ¥çš„äº§ç”Ÿ

inhibit_rules é…ç½®ä¿¡æ¯

```yaml
trget_match:
     [ <label_name>: <labelvalue>,... ]
trget_match_re:
     [ <label_name>: <labelvalue>,... ]
source_match:
     [ <label_name>: <labelvalue>,... ]
source_match_re:
     [ <label_name>: <labelvalue>,... ]
[ equal: '[' <lable_name>, ...]']
```

#### 3.è­¦æŠ¥æ¥æ”¶é€šçŸ¥å™¨

##### 3.1 Email

**åœ¨ prometheus ä¸­é…ç½®å‘ç° alertmanager è§„åˆ™**

```yaml
rule_files:
  - "alert.rules.yml"  # è‡ªå·±åˆ›å»ºä¸‹è¿™ä¸ªæ–‡ä»¶

alerting:
  alertmanagers:
    - static_configs:
        - targets: ["10.0.0.21:9093"]  # Alertmanager çš„åœ°å€
```

**åœ¨ alert.rules.yml ä¸­æ·»åŠ å‘Šè­¦è§„åˆ™**

```yaml
groups:
  - name: memory_alert
    rules:
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡é«˜"
          description: "å†…å­˜ä½¿ç”¨ç‡å·²è¾¾åˆ° {{ $value }}%"
```

**alertmanager é…ç½®å¦‚ä¸‹**

```yaml
global:
  resolve_timeout: 5m
  # smtpé…ç½®
  smtp_from: "156xxxx2568@163.com" # å‘é€é‚®ä»¶ä¸»é¢˜
  smtp_smarthost: 'smtp.163.com:465' # é‚®ç®±æœåŠ¡å™¨çš„SMTPä¸»æœºé…ç½®
  smtp_auth_username: "156xxxx2568@163.com" # ç™»å½•ç”¨æˆ·å
  smtp_auth_password: "BMxxxx6uhxxxxVLk" # æ­¤å¤„çš„auth passwordæ˜¯é‚®ç®±çš„ç¬¬ä¸‰æ–¹ç™»å½•æˆæƒå¯†ç ï¼Œè€Œéç”¨æˆ·å¯†ç ï¼Œå°½é‡ç”¨QQæ¥æµ‹è¯•ã€‚
  smtp_require_tls: false # æœ‰äº›é‚®ç®±éœ€è¦å¼€å¯æ­¤é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯163é‚®ç®±ï¼Œä»…åšæµ‹è¯•ï¼Œä¸éœ€è¦å¼€å¯æ­¤åŠŸèƒ½ã€‚
route:
  receiver: email-alert
  group_wait: 30s # åœ¨ç»„å†…ç­‰å¾…æ‰€é…ç½®çš„æ—¶é—´ï¼Œå¦‚æœåŒç»„å†…ï¼Œ30ç§’å†…å‡ºç°ç›¸åŒæŠ¥è­¦ï¼Œåœ¨ä¸€ä¸ªç»„å†…å‡ºç°ã€‚
  group_interval: 5m # å¦‚æœç»„å†…å†…å®¹ä¸å˜åŒ–ï¼Œåˆå¹¶ä¸ºä¸€æ¡è­¦æŠ¥ä¿¡æ¯ï¼Œ5måå‘é€ã€‚
  repeat_interval: 1h # å‘é€æŠ¥è­¦é—´éš”ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä¿®å¤ï¼Œåˆ™é‡æ–°å‘é€æŠ¥è­¦ã€‚
  group_by: [alertname]  # æŠ¥è­¦åˆ†ç»„
  routes:
      - match:
          severity: warning
        receiver: 'email-alert'
      - receiver: email-alert # è·¯ç”±å’Œæ ‡ç­¾ï¼Œæ ¹æ®matchæ¥æŒ‡å®šå‘é€ç›®æ ‡ï¼Œå¦‚æœ ruleçš„lable åŒ…å« alertnameï¼Œ ä½¿ç”¨ ops æ¥å‘é€
        group_wait: 10s
        match:
          severity: warning
# æ¥æ”¶å™¨æŒ‡å®šå‘é€äººä»¥åŠå‘é€æ¸ é“
receivers:
# opsåˆ†ç»„çš„å®šä¹‰
- name: email-alert
  email_configs:
  - to: '156xxxx2568@163.com' # å¦‚æœæƒ³å‘é€å¤šä¸ªäººå°±ä»¥ ','åšåˆ†å‰²ï¼Œå†™å¤šä¸ªé‚®ä»¶äººå³å¯ã€‚
    send_resolved: true
    headers:
      subject: "[operations] æŠ¥è­¦é‚®ä»¶"
```

**é‡å¯æœåŠ¡ prometheus å’Œ alertmanager**

å¯¹å†…å­˜è¿›è¡Œå‹æµ‹ï¼šdd if=/dev/zero of=/dev/null bs=1G count=102400

æŠ¥è­¦çŸ­ä¿¡å¦‚ä¸‹

 <img src="/img/image-20250103171338208.png" alt="image-20250103171338208" style="zoom: 50%;" />æ¢å¤çŸ­ä¿¡å¦‚ä¸‹

 <img src="/img/image-20250103171643533.png" alt="image-20250103171643533" style="zoom:50%;" />**ä½¿ç”¨æ¨¡æ¿æ¥è‡ªå®šä¹‰é€šçŸ¥**

æ¨¡æ¿å¦‚ä¸‹

```tmpl
{{ define "email.html" }}
{{- if gt (len .Alerts.Firing) 0 -}}{{ range .Alerts }}
<h2>@å‘Šè­¦é€šçŸ¥</h2>
å‘Šè­¦ç¨‹åº: prometheus_alert <br>
å‘Šè­¦çº§åˆ«: {{ .Labels.severity }} çº§ <br>
å‘Šè­¦ç±»å‹: {{ .Labels.alertname }} <br>
æ•…éšœä¸»æœº: {{ .Labels.instance }} <br>
å‘Šè­¦ä¸»é¢˜: {{ .Annotations.summary }} <br>
å‘Šè­¦è¯¦æƒ…: {{ .Annotations.description }} <br>
è§¦å‘æ—¶é—´: {{ .StartsAt.Local.Format "2006-01-02 15:04:05" }} <br>
{{ end }}{{ end -}}
{{- if gt (len .Alerts.Resolved) 0 -}}{{ range .Alerts }}
<h2>@å‘Šè­¦æ¢å¤</h2>
å‘Šè­¦ç¨‹åº: prometheus_alert <br>
æ•…éšœä¸»æœº: {{ .Labels.instance }} <br>
æ•…éšœä¸»é¢˜: {{ .Annotations.summary }} <br>
å‘Šè­¦è¯¦æƒ…: {{ .Annotations.description }} <br>
å‘Šè­¦æ—¶é—´: {{ .StartsAt.Local.Format "2006-01-02 15:04:05" }} <br>
æ¢å¤æ—¶é—´: {{ .EndsAt.Local.Format "2006-01-02 15:04:05" }}<br>
{{ end }}{{ end -}}
{{- end }}
```

åœ¨ alertmanager ä¸­å¯¼å…¥æ­¤æ¨¡æ¿ï¼Œåœ¨ receivers ä¸­ä½¿ç”¨æ¨¡æ¿ä¿¡æ¯

```yaml
templates:   #å®šä¹‰å¾®ä¿¡å‘Šè­¦å†…å®¹æ¨¡æ¿
  - '/opt/alertmanager/alertmanager/*.tmpl'
receivers:
# opsåˆ†ç»„çš„å®šä¹‰
- name: email-alert
  email_configs:
  - to: '15xxxxx568@163.com' # å¦‚æœæƒ³å‘é€å¤šä¸ªäººå°±ä»¥ ','åšåˆ†å‰²ï¼Œå†™å¤šä¸ªé‚®ä»¶äººå³å¯ã€‚
    send_resolved: true
    headers:
      subject: "[operations] æŠ¥è­¦é‚®ä»¶"
    html: '{{ template "email.html" . }}'
```

é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼šcurl -X POST http://localhost:9093/-/reload

<img src="/img/07435ab9f93426f4b075fb75f387385.jpg" alt="07435ab9f93426f4b075fb75f387385" style="zoom:15%;" /><img src="/img/df0929875580e7333ed300b4b4c7e82.jpg" alt="df0929875580e7333ed300b4b4c7e82" style="zoom:15%;" />

##### 3.2 ä¼ä¸šå¾®ä¿¡

prometheus -- alertmanager -- prometheus-webhook-wechat-main -- ä¼ä¸šå¾®ä¿¡

é¦–å…ˆä½ è¦å…·æœ‰ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥è‡ªå·±æ³¨å†Œä¸€ä¸ªï¼Œè¿›è¡Œæµ‹è¯•ï¼Œæˆ‘è¿™é‡Œæœ‰è‡ªè¡Œæ³¨å†Œçš„ä¼ä¸šå¾®ä¿¡

å…·ä½“åˆ›å»ºè¿‡ç¨‹çœç•¥

1.ç¬¬ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡ä¼ä¸šæœºå™¨äººå®ç°æŠ¥è­¦ï¼Œä½†æ˜¯éœ€è¦é…ç½®å®é™…åŸŸåç­‰ï¼Œå¦‚æœåªæ˜¯åšæµ‹è¯•ï¼Œè¿™ç§æ–¹å¼ç”¨ä¸äº†ã€‚ä¸»è¦æ˜¯éœ€è¦è·å–åˆ°1.ä¼ä¸šIDï¼Œ2.å‘Šè­¦éƒ¨é—¨IDï¼Œ3.æœºå™¨äººIDï¼Œ4.æœºå™¨äººå¯†é’¥

2.ç¬¬äºŒç§æ–¹å¼æ˜¯é€šè¿‡ä¼ä¸šå¾®ä¿¡ç¾¤åˆ›å»ºæœºå™¨äººï¼Œè·å–æœºå™¨äººçš„ webhook è¿›è¡Œé…ç½®

è¿™é‡Œé‡‡ç”¨ç¬¬äºŒç§æ–¹å¼è¿›è¡Œæ¼”ç¤º

**1.è·å– weebhook**

 <img src="/img/image-20250104134902086.png" alt="image-20250104134902086" style="zoom:80%;" />**2.å¯åŠ¨ go åº”ç”¨ï¼šprometheus-webhook-wechat-main**

ä¼ä¸šå¾®ä¿¡ webhook éœ€è¦ç”¨åˆ°è¿™ä¸ªå·¥å…·

ä¸‹è½½åœ°å€ï¼šhttps://github.com/SecurityNeo/prometheus-webhook-wechat

æ–‡ä»¶ç§æä¾›äº† Dockerfileï¼Œä¹Ÿå¯ä»¥ç”¨ docker éƒ¨ç½²ï¼Œè¿™é‡Œé€‰æ‹©ç›´æ¥å¯ç”¨è¿™ä¸ªåº”ç”¨

vim config.yml

```yaml
maxContentLength: 4096
targets:
  webhook1:
    url: xxx # å¡«ä¸Šå‰é¢çš„ Webhook åœ°å€
```

æˆ‘ä»¬å†åˆ° ./cmd/main.go ä¸­æŸ¥çœ‹ä¸‹é¡¹ç›®è®¿é—®è·¯å¾„ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ï¼š/wechat/webhook/sendï¼Œç­‰ä¸€ä¸‹ä¼šç”¨åˆ°

 <img src="/img/image-20250104195315993.png" alt="image-20250104195315993" style="zoom:80%;" />å¯åŠ¨åº”ç”¨ï¼šnohup ./prometheus-webhook-wechat --listen-port=':9999' &ï¼Œè¿™é‡Œè®¾ç½®äº†è®¿é—®ç«¯å£ä¸º 9999ï¼Œé»˜è®¤ä¸º 80

**3.é…ç½® alertmanager.yml**

ä¸»è¦æ˜¯é…ç½®è·¯ç”±å’Œæ¥æ”¶å™¨ï¼Œä»¥ä¸‹æ˜¯æˆ‘åšæµ‹è¯•çš„ä¾‹å­

```yaml
global:
  resolve_timeout: 5m
  # smtpé…ç½®
  smtp_from: "156xxxx2568@163.com" # å‘é€é‚®ä»¶ä¸»é¢˜
  smtp_smarthost: 'smtp.163.com:465' # é‚®ç®±æœåŠ¡å™¨çš„SMTPä¸»æœºé…ç½®
  smtp_auth_username: "156xxxx2568@163.com" # ç™»å½•ç”¨æˆ·å
  smtp_auth_password: "BMqQpxxxxxxiUqVLk" # æ­¤å¤„çš„auth passwordæ˜¯é‚®ç®±çš„ç¬¬ä¸‰æ–¹ç™»å½•æˆæƒå¯†ç ï¼Œè€Œéç”¨æˆ·å¯†ç ï¼Œå°½é‡ç”¨QQæ¥æµ‹è¯•ã€‚
  smtp_require_tls: false # æœ‰äº›é‚®ç®±éœ€è¦å¼€å¯æ­¤é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯163é‚®ç®±ï¼Œä»…åšæµ‹è¯•ï¼Œä¸éœ€è¦å¼€å¯æ­¤åŠŸèƒ½ã€‚

templates:                                                                              #å®šä¹‰å¾®ä¿¡å‘Šè­¦å†…å®¹æ¨¡æ¿
  - '/opt/alertmanager/alertmanager/wechat.tmpl'

route:
  receiver: email-alert
  group_wait: 30s # åœ¨ç»„å†…ç­‰å¾…æ‰€é…ç½®çš„æ—¶é—´ï¼Œå¦‚æœåŒç»„å†…ï¼Œ30ç§’å†…å‡ºç°ç›¸åŒæŠ¥è­¦ï¼Œåœ¨ä¸€ä¸ªç»„å†…å‡ºç°ã€‚
  group_interval: 5m # å¦‚æœç»„å†…å†…å®¹ä¸å˜åŒ–ï¼Œåˆå¹¶ä¸ºä¸€æ¡è­¦æŠ¥ä¿¡æ¯ï¼Œ5måå‘é€ã€‚
  repeat_interval: 1h # å‘é€æŠ¥è­¦é—´éš”ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä¿®å¤ï¼Œåˆ™é‡æ–°å‘é€æŠ¥è­¦ã€‚
  group_by: [alertname]  # æŠ¥è­¦åˆ†ç»„
  routes:
      - match:
          severity: warning
        receiver: 'wechat-webhook'
# æ¥æ”¶å™¨æŒ‡å®šå‘é€äººä»¥åŠå‘é€æ¸ é“
receivers:
# opsåˆ†ç»„çš„å®šä¹‰
- name: email-alert
  email_configs:
  - to: '156xxxx2568@163.com' # å¦‚æœæƒ³å‘é€å¤šä¸ªäººå°±ä»¥ ','åšåˆ†å‰²ï¼Œå†™å¤šä¸ªé‚®ä»¶äººå³å¯ã€‚
    send_resolved: true
    headers:
      subject: "[operations] æŠ¥è­¦é‚®ä»¶"
- name: 'wechat'
  wechat_configs:
    - corp_id: 'ww982xxxxxx442eea'
      to_party: '1'
      agent_id: '100xxx4'
      api_secret: '18gWU4T9PKv-KAhIxxxxxKCbXopyDAWE'
      send_resolved: true
      message: '{{ template "wechat.default.message" . }}'
- name: 'wechat-webhook'
  webhook_configs:
    - url: "http://10.0.0.20:9999/wechat/webhook/send"
      send_resolved: true # æ˜¯å¦å‘é€æ¢å¤é€šçŸ¥
```

å…¶ä¸­æœ€é‡è¦æ˜¯å°±æ˜¯åœ¨é…ç½® receivers æ—¶ç”¨åˆ°åˆšåˆšçš„è·¯å¾„ï¼šhttp://10.0.0.20:9999/wechat/webhook/send

**4.é…ç½®é€šçŸ¥æ¨¡æ¿**

```yaml
{{ define "__subject" }}
[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}]
{{ end }}


{{ define "__alert_list" }}{{ range . }}
---
>**å‘Šè­¦ä¸»é¢˜**: {{ .Annotations.summary }}
>**å‘Šè­¦ç±»å‹**: {{ .Labels.alertname }}
>**å‘Šè­¦çº§åˆ«**: {{ .Labels.severity }}
>**å‘Šè­¦å®ä¾‹**: {{ .Labels.instance }}
>**å‘Šè­¦å†…å®¹**: {{ index .Annotations "description" }}
>**å‘Šè­¦æ¥æº**: [{{ .GeneratorURL }}]({{ .GeneratorURL }})
>**å‘Šè­¦æ—¶é—´**: {{ .StartsAt.Local.Format "2006-01-02 15:04:05" }}
{{ end }}{{ end }}

{{ define "__resolved_list" }}{{ range . }}
---
>**å‘Šè­¦ä¸»é¢˜**: {{ .Annotations.summary }}
>**å‘Šè­¦ç±»å‹**: {{ .Labels.alertname }}
>**å‘Šè­¦çº§åˆ«**: {{ .Labels.severity }}
>**å‘Šè­¦å®ä¾‹**: {{ .Labels.instance }}
>**å‘Šè­¦å†…å®¹**: {{ index .Annotations "description" }}
>**å‘Šè­¦æ¥æº**: [{{ .GeneratorURL }}]({{ .GeneratorURL }})
>**å‘Šè­¦æ—¶é—´**: {{ .StartsAt.Local.Format "2006-01-02 15:04:05" }}
>**æ¢å¤æ—¶é—´**: {{ .EndsAt.Local.Format "2006-01-02 15:04:05" }}
{{ end }}{{ end }}


{{ define "msg.title" }}
{{ template "__subject" . }}
{{ end }}

{{ define "msg.content" }}
{{ if gt (len .Alerts.Firing) 0 }}
**äº§ç”Ÿ<font color="warning">{{ .Alerts.Firing | len  }}</font>ä¸ªæ•…éšœ**
{{ template "__alert_list" .Alerts.Firing }}
{{ end }}

{{ if gt (len .Alerts.Resolved) 0 }}
**æ¢å¤<font color="info">{{ .Alerts.Resolved | len  }}</font>ä¸ªæ•…éšœ**
{{ template "__resolved_list" .Alerts.Resolved }}
{{ end }}
{{ end }}

{{ template "msg.title" . }}
{{ template "msg.content" . }}
```

é‡æ–°å¯ç”¨ä¸‹ï¼Œè®© webhook é¡¹ç›®åº”ç”¨åˆ°è‡ªå®šä¹‰æ¨¡æ¿ï¼š

nohup ./prometheus-webhook-wechat --listen-port=':9999' --template.file=template.tmpl &

**5.æµ‹è¯•æŠ¥è­¦ä¸æ¢å¤**

dd if=/dev/zero of=/dev/null bs=1G count=102400

<img src="/img/image-20250104200630210.png" alt="image-20250104200630210" style="zoom:80%;" />

<img src="/img/image-20250104201130475.png" alt="image-20250104201130475" style="zoom:80%;" />

å‘ç°äº†1ä¸ªé—®é¢˜ï¼Œæä¾›çš„å‘Šè­¦æ¥æºä¸»æœºæ˜¯ localhostï¼Œæ¥ä¸‹æ¥å°† localhost ä¿®æ”¹ä¸º prometheus ä¸»æœºçš„IP

é‡æ–°å¯åŠ¨ promethusï¼ˆåŠ ä¸Šå‚æ•°ï¼‰ï¼šnohup ./prometheus --web.external-url=http://10.0.0.20:9090 &

å¦‚æœä¸æ–¹ä¾¿é‡å¯ prometheus è¿˜æœ‰ä¸€äº›åˆ«çš„æ–¹æ³•ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥é˜…èµ„æ–™

<img src="/img/image-20250104211553313.png" alt="image-20250104211553313" style="zoom:80%;" />

##### 3.3 é’‰é’‰æœºå™¨äºº WebHook

prometheus -- alertmanager -- rometheus-webhook-dingtalk -- é’‰é’‰

æ³¨å†Œé’‰é’‰ï¼šhttp://oa.dingtalk.com

éšä¾¿æ³¨å†Œ1ä¸ªä¼ä¸š

 <img src="/img/image-20250105115329401.png" alt="image-20250105115329401" style="zoom: 50%;" />æ·»åŠ é’‰é’‰æœºå™¨äººï¼ˆç”¨ PC ç«¯é’‰é’‰æ·»åŠ ï¼‰

 <img src="/img/image-20250105120511952.png" alt="image-20250105120511952" style="zoom: 50%;" />æˆ‘ä»¬ä¸€èˆ¬æŠŠå‘Šè­¦ä¿¡æ¯å‘é€ç»™ä¸€ä¸ªéƒ¨é—¨ï¼Œç„¶åæŠŠå¤„ç†æ•…éšœçš„äººå‘˜æ·»åŠ åˆ°è¿™ä¸ªéƒ¨é—¨

åˆ›å»º1ä¸ªå­éƒ¨é—¨ï¼Œç„¶åæŠŠè‡ªå·±çš„è´¦å·æ·»åŠ åˆ°è¯¥éƒ¨é—¨ä¸‹

 <img src="/img/image-20250105120902491.png" alt="image-20250105120902491" style="zoom:50%;" /> <img src="/img/image-20250105121008834.png" alt="image-20250105121008834" style="zoom:50%;" />å›åˆ°é’‰é’‰ï¼Œå‘ç°è‡ªåŠ¨åˆ›å»ºäº†éƒ¨é—¨ç¾¤

 <img src="/img/image-20250105121119007.png" alt="image-20250105121119007" style="zoom:50%;" />è®¾ç½® -- æœºå™¨äºº -- æ·»åŠ æœºå™¨äºº -- è‡ªå®šä¹‰ -- æ·»åŠ 

 <img src="/img/image-20250105130036204.png" alt="image-20250105130036204" style="zoom:50%;" />æ·»åŠ æœºå™¨äººæ—¶éœ€è¦æ·»åŠ  IP åœ°å€/æ®µï¼Œå¦‚æœæ˜¯è™šæ‹Ÿç¯å¢ƒéƒ¨ç½²çš„åº”ç”¨ï¼Œå¯ä»¥åœ¨ ip138.com æŸ¥è¯¢æœ¬æœºIP

 <img src="/img/image-20250105130328322.png" alt="image-20250105130328322" style="zoom:50%;" />ä¿å­˜ webhook åœ°å€

 <img src="/img/image-20250105130440401.png" alt="image-20250105130440401" style="zoom:50%;" />ä¸‹è½½ prometheus-webhook-dingtalkï¼šhttps://github.com/timonwong/prometheus-webhook-dingtalk

**æ­¤é¡¹ç›®ä½¿ç”¨ go ç¯å¢ƒï¼Œå…ˆç»™ä¸‹è½½ go ï¼Œç„¶åé…ç½®ç¯å¢ƒå˜é‡**

ç¼–è¯‘é¡¹ç›®ï¼šgo build -o prometheus-webhook-dingtalk ./cmd/prometheus-webhook-dingtalk

é…ç½®æ–‡ä»¶ï¼ˆconfig.ymlï¼‰ï¼šcp config.example.yml config.yml

```yaml
targets:
  webhook1:
    url: https://oapi.dingtalk.com/robot/send?access_token=7e9xxxxbb6xxxxa7b0c8b2e725aadxxxx24a2f9fae0d6
    secret: SEC000000000000000000000
```

æŸ¥çœ‹è·¯ç”±å‘ç°è®¿é—®è·¯å¾„ä¸ºï¼ˆmain.goï¼‰ï¼š/dingtalk/webhook1/send

å¯åŠ¨é¡¹ç›®ï¼šnohup ./prometheus-webhook-dingtalk --web.listen-address=:8888 &

**é…ç½® alertmanager.yml**

```yaml
- name: 'dingtalk-webhook'
  webhook_configs:
    - url: "http://10.0.0.20:8888/dingtalk/webhook1/send"
      send_resolved: true
```

**æµ‹è¯•æŠ¥è­¦ä¸æ¢å¤**

#####  <img src="/img/image-20250105133640661.png" alt="image-20250105133640661" style="zoom:80%;" /> <img src="/img/image-20250105133939915.png" alt="image-20250105133939915" style="zoom:80%;" />3.4 é—®é¢˜è®°å½•

1.é…ç½® go ç¯å¢ƒå˜é‡

```shell
vim /etc/profile
export PATH=$PATH:/usr/local/go/bin
source /etc/profile
go version
```

2.ç¼–è¯‘ go é¡¹ç›®æ—¶å¡ä½äº†

```shell
# é…ç½®ä»£ç†å‘½ä»¤
go env -w GOPROXY=https://goproxy.cn,direct
# éªŒè¯ä»£ç†æ˜¯å¦ç”Ÿæ•ˆ è¾“å‡ºç±»ä¼¼ GOPROXY="https://goproxy.cn,direct"
go env | grep GOPROXY
# æ¸…ç†å¹¶é‡æ–°æ‹‰å–ä¾èµ–
go mod tidy
go build -o prometheus-webhook-wechat ./cmd/main.go
```

3.é€šè¿‡ main.go æ‰¾åˆ° webhook æ­£ç¡®å¤„ç†è¯·æ±‚çš„åœ°å€

4.ä¿®æ”¹ localhost æ˜¾ç¤ºä¸ºæˆ‘çš„ prometheus çš„ä¸»æœºIP

é‡æ–°å¯åŠ¨ promethusï¼ˆåŠ ä¸Šå‚æ•°ï¼‰ï¼šnohup ./prometheus --web.external-url=http://10.0.0.20:9090 &

è¿˜å¯ä»¥ä¿®æ”¹æ¨¡æ¿ä¿¡æ¯æ¥æ”¹å˜

5.è¿™äº›åº”ç”¨ä¹Ÿæä¾›äº† Dockerfile çš„æ–¹å¼å¸®åŠ©ä» docker æ„å»ºï¼Œä¹Ÿå¯ä»¥è¯•ä¸€ä¸‹

##### 3.5 è­¦æŠ¥é€šçŸ¥æ¨¡æ¿

Prometheus åˆ›å»ºè­¦æŠ¥è½¬å‘ç»™ Alertmanagerï¼ŒAlertmanager ä¼šæ ¹æ®ä¸åŒçš„ Label å‘ä¸åŒçš„ Receiver å‘é€è­¦æŠ¥é€šçŸ¥ï¼Œå¦‚ Emailã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é£ä¹¦ã€çŸ­ä¿¡ç­‰ç­‰ï¼Œæ‰€æœ‰ Receiveréƒ½ä¸€ä¸ªæ¥æ”¶æ¨¡æ¿ï¼Œç„¶åé€šè¿‡æ¨¡æ¿æ ¼å¼åŒ–ä»¥åå‘é€è­¦æŠ¥ä¿¡æ¯ç»™ Receiver

Alertmanager è‡ªå¸¦çš„æ¨¡æ¿æ˜¯åŸºäº Go è¯­è¨€çš„ template æ¨¡æ¿ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å»å®šä¹‰è‡ªå·±éœ€è¦çš„æ¨¡æ¿

**é‚®ä»¶æ¨¡æ¿**

```
{{ define "email.html" }}
{{- if gt (len .Alerts.Firing) 0 -}}{{ range .Alerts }}
<h2>@å‘Šè­¦é€šçŸ¥</h2>
å‘Šè­¦ç¨‹åº: prometheus_alert <br>
å‘Šè­¦çº§åˆ«: {{ . Labels.severity }} çº§ <br>
å‘Šè­¦ç±»å‹: {{ . Labels.alertname }} <br>
æ•…éšœä¸»æœº: {{ . Labels.instance }} <br>
å‘Šè­¦ä¸»é¢˜: {{ . Annotations.summary }} <br>
å‘Šè­¦è¯¦æƒ…: {{ .Annotations.description }} <br>
è§¦å‘æ—¶é—´: {{ . StartsAt.Local.Format "2006-01-02 15:04:05" }} <br>
{{ end }}{{ end -}}
{{- if gt (len .Alerts.Resolved) 0 -}}{{ range .Alerts }}
<h2>@å‘Šè­¦æ¢å¤</h2>
å‘Šè­¦ç¨‹åº: prometheus_alert <br>
æ•…éšœä¸»æœº: {{ .Labels.instance }} <br>
æ•…éšœä¸»é¢˜: {{ .Annotations.summary }} <br>
å‘Šè­¦è¯¦æƒ…:{{ .Annotations.description }} <br>
å‘Šè­¦æ—¶é—´: {{ .StartsAt.Local.Format "2006-01-02 15:04:05" }} <br>
æ¢å¤æ—¶é—´: {{ .EndsAt.Local.Format "2006-01-02 15:04:05" }}<br>
{{ end }}{{ end -}}
{{- end }}
```

**Wechat æ¨¡æ¿**

```
cat wechat.tmpl
## wechatæ¨¡æ¿
{{ define "wechat.default.message" }}
{{ if gt (len .Alerts.Firing) 0 -}}
Alerts Firing:
{{ range .Alerts }}
è­¦æŠ¥çº§åˆ«ï¼š{{ .Labels.status }}

è­¦æŠ¥ç±»å‹ï¼š{{ .Labels.alertname }}

æ•…éšœä¸»æœº: {{ .Labels.instance }}

è­¦æŠ¥ä¸»é¢˜: {{ .Annotations.summary }}

è­¦æŠ¥è¯¦æƒ…: {{ .Annotations.description }}

â± : {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
{{- end }}
{{- end }}

{{ if gt (len .Alerts.Resolved) 0 -}}
Alerts Resolved:
{{ range .Alerts }}
è­¦æŠ¥çº§åˆ«ï¼š{{ .Labels.status }}

è­¦æŠ¥ç±»å‹ï¼š{{ .Labels.alertname }}

æ•…éšœä¸»æœº: {{ .Labels.instance }}

è­¦æŠ¥ä¸»é¢˜: {{ .Annotations.summary }}

è­¦æŠ¥è¯¦æƒ…: {{ .Annotations.description }}

â± : {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
â² : {{ (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
{{- end }}
{{- end }}
{{- end }}
```

**é’‰é’‰æ¨¡æ¿**

```
cd /etc/prometheus-webhook-dingtalk/template
cat default.tmpl
{{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}
{{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}

{{ define "__text_alert_list" }}{{ range . }}
**Labels**
{{ range .Labels.SortedPairs }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}
**Annotations**
{{ range .Annotations.SortedPairs }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}
**Source:** [{{ .GeneratorURL }}]({{ .GeneratorURL }})
{{ end }}{{ end }}

{{/* Firing */}}

{{ define "default.__text_alert_list" }}{{ range . }}

**Trigger Time:** {{ dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" }}

**Summary:** {{ .Annotations.summary }}

**Description:** {{ .Annotations.description }}

**Graph:** [ğŸ“ˆ ]({{ .GeneratorURL }})

**Details:**
{{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}{{ end }}
{{ end }}{{ end }}

{{/* Resolved */}}

{{ define "default.__text_resolved_list" }}{{ range . }}

**Trigger Time:** {{ dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" }}

**Resolved Time:** {{ dateInZone "2006.01.02 15:04:05" (.EndsAt) "Asia/Shanghai" }}

**Summary:** {{ .Annotations.summary }}

**Graph:** [ğŸ“ˆ ]({{ .GeneratorURL }})

**Details:**
{{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}{{ end }}
{{ end }}{{ end }}

{{/* Default */}}
{{ define "default.title" }}{{ template "__subject" . }}{{ end }}
{{ define "default.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
{{ if gt (len .Alerts.Firing) 0 -}}

![Firing-img](https://is3-ssl.mzstatic.com/image/thumb/Purple20/v4/e0/23/cf/e023cf56-0623-0cdf-afce-97ae90eabfda/mzl.uplmrpgi.png/320x0w.jpg)

**Alerts Firing**
{{ template "default.__text_alert_list" .Alerts.Firing }}
{{- end }}
{{ if gt (len .Alerts.Resolved) 0 -}}

![Resolved-img](https://is3-ssl.mzstatic.com/image/thumb/Purple18/v4/41/72/99/4172990a-f666-badf-9726-6204a320c16e/mzl.dypdixoy.png/320x0w.png)

**Alerts Resolved**
{{ template "default.__text_resolved_list" .Alerts.Resolved }}
{{- end }}
{{- end }}

{{/* Legacy */}}
{{ define "legacy.title" }}{{ template "__subject" . }}{{ end }}
{{ define "legacy.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
{{ template "__text_alert_list" .Alerts.Firing }}
{{- end }}

{{/* Following names for compatibility */}}
{{ define "ding.link.title" }}{{ template "default.title" . }}{{ end }}
{{ define "ding.link.content" }}{{ template "default.content" . }}{{ end }}
```

### Grafana + OneAlert å‘Šè­¦

å®˜ç½‘ï¼šhttps://www.aiops.com/

1.è¿›å…¥ OneAlert çš„æ™ºèƒ½å‘Šè­¦å¹³å° CloudAlert

2.é…ç½®é€šçŸ¥ç­–ç•¥

 <img src="/img/image-20241220135326557.png" alt="image-20241220135326557" style="zoom:80%;" />

3.é…ç½®åˆ†æ´¾ç­–ç•¥

 <img src="/img/image-20241220135437401.png" alt="image-20241220135437401" style="zoom:80%;" />

4.é›†æˆç›‘æ§å·¥å…·

<img src="/img/image-20241220135943375.png" alt="image-20241220135943375" style="zoom:80%;" />

5.Grafana ç»‘å®š OneAlert

<img src="/img/image-20241220140418700.png" alt="image-20241220140418700" style="zoom:80%;" />

é…ç½®å¥½åï¼Œå¯ä»¥ç‚¹ Test è¯•ä¸€ä¸‹ï¼Œå‘ç°æœ‰ä¸ªå‘Šè­¦ç”µè¯æ‰“è¿‡æ¥äº†

<img src="/img/image-20241220140826087.png" alt="image-20241220140826087" style="zoom:80%;" />

6.è®¾ç½®å‘Šè­¦ç­–ç•¥

<img src="/img/image-20241220141328313.png" alt="image-20241220141328313" style="zoom:80%;" />

7.è®¾ç½®å‘Šè­¦

æ‹¿ä¹‹å‰åˆ›å»ºçš„æ¨¡æ¿ä¸¾ä¾‹

 <img src="/img/image-20241220141611849.png" alt="image-20241220141611849" style="zoom:80%;" />

 <img src="/img/image-20241220142406131.png" alt="image-20241220142406131" style="zoom:80%;" />

 <img src="/img/image-20241220142633509.png" alt="image-20241220142633509" style="zoom:80%;" />

å½“ cpu åœ¨ 1 åˆ†é’Ÿå†…çš„è´Ÿè½½å¤§äº 0.8 æ—¶å‘Šè­¦

 <img src="/img/image-20241220142722511.png" alt="image-20241220142722511" style="zoom:80%;" />

 <img src="/img/image-20241220143551479.png" alt="image-20241220143551479" style="zoom:80%;" />

 <img src="/img/image-20241220144046829.png" alt="image-20241220144046829" style="zoom:80%;" />

æ¥ä¸‹æ¥å‹æµ‹ CPUï¼šcat /dev/urandom | gzip -9 > /dev/null

 <img src="/img/image-20241220144527152.png" alt="image-20241220144527152" style="zoom:80%;" />

 <img src="/img/image-20241220144700878.png" alt="image-20241220144700878" style="zoom:80%;" />

<img src="/img/image-20241220144846788.png" alt="image-20241220144846788" style="zoom:80%;" />