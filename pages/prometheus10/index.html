<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prometheus 告警 | 星途物语</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/logo.ico">
    <script language="javascript" type="text/javascript" src="/js/pgmanor-self.js"></script>
    <meta name="description" content="星途物语">
    <meta name="keywords" content="星途物语、运维、编程">
    <meta name="theme-color" content="#11a8cd">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/assets/css/0.styles.4f839b66.css" as="style"><link rel="preload" href="/assets/js/app.f4b69cc5.js" as="script"><link rel="preload" href="/assets/js/2.21d43cdc.js" as="script"><link rel="preload" href="/assets/js/116.c7015e4e.js" as="script"><link rel="prefetch" href="/assets/js/10.c60f46c3.js"><link rel="prefetch" href="/assets/js/100.03e8bf9a.js"><link rel="prefetch" href="/assets/js/101.09d4655a.js"><link rel="prefetch" href="/assets/js/102.ee280c02.js"><link rel="prefetch" href="/assets/js/103.11cd00ed.js"><link rel="prefetch" href="/assets/js/104.f0aca29c.js"><link rel="prefetch" href="/assets/js/105.682bc565.js"><link rel="prefetch" href="/assets/js/106.0735ac65.js"><link rel="prefetch" href="/assets/js/107.72793c42.js"><link rel="prefetch" href="/assets/js/108.b27e9db4.js"><link rel="prefetch" href="/assets/js/109.5e9f45e2.js"><link rel="prefetch" href="/assets/js/11.4149d35c.js"><link rel="prefetch" href="/assets/js/110.b0268227.js"><link rel="prefetch" href="/assets/js/111.06f5ff01.js"><link rel="prefetch" href="/assets/js/112.28a18819.js"><link rel="prefetch" href="/assets/js/113.ee2d94b9.js"><link rel="prefetch" href="/assets/js/114.7198fa07.js"><link rel="prefetch" href="/assets/js/115.94a6cec2.js"><link rel="prefetch" href="/assets/js/117.d37f4218.js"><link rel="prefetch" href="/assets/js/118.a580af3c.js"><link rel="prefetch" href="/assets/js/119.ed97f913.js"><link rel="prefetch" href="/assets/js/12.359b1624.js"><link rel="prefetch" href="/assets/js/120.98ccb424.js"><link rel="prefetch" href="/assets/js/121.5d39601a.js"><link rel="prefetch" href="/assets/js/122.d348cba8.js"><link rel="prefetch" href="/assets/js/123.f441bff0.js"><link rel="prefetch" href="/assets/js/124.e1258cca.js"><link rel="prefetch" href="/assets/js/125.a04104a5.js"><link rel="prefetch" href="/assets/js/126.e812df55.js"><link rel="prefetch" href="/assets/js/127.3955ac5a.js"><link rel="prefetch" href="/assets/js/128.d9c5a480.js"><link rel="prefetch" href="/assets/js/129.7ff35111.js"><link rel="prefetch" href="/assets/js/13.1a47524b.js"><link rel="prefetch" href="/assets/js/130.ce56bb38.js"><link rel="prefetch" href="/assets/js/131.7217329c.js"><link rel="prefetch" href="/assets/js/132.aaba96e1.js"><link rel="prefetch" href="/assets/js/133.6a26898e.js"><link rel="prefetch" href="/assets/js/134.077d0cfe.js"><link rel="prefetch" href="/assets/js/135.2500e24f.js"><link rel="prefetch" href="/assets/js/14.05d3f4f6.js"><link rel="prefetch" href="/assets/js/15.f4388cb1.js"><link rel="prefetch" href="/assets/js/16.f4e83281.js"><link rel="prefetch" href="/assets/js/17.396974f2.js"><link rel="prefetch" href="/assets/js/18.52372899.js"><link rel="prefetch" href="/assets/js/19.a86a8851.js"><link rel="prefetch" href="/assets/js/20.0725d9bb.js"><link rel="prefetch" href="/assets/js/21.b129a971.js"><link rel="prefetch" href="/assets/js/22.8f2f2ef9.js"><link rel="prefetch" href="/assets/js/23.6a25c53e.js"><link rel="prefetch" href="/assets/js/24.b4a97fd2.js"><link rel="prefetch" href="/assets/js/25.5bff80fd.js"><link rel="prefetch" href="/assets/js/26.25ef6e74.js"><link rel="prefetch" href="/assets/js/27.3b5eee0c.js"><link rel="prefetch" href="/assets/js/28.34176e74.js"><link rel="prefetch" href="/assets/js/29.da150951.js"><link rel="prefetch" href="/assets/js/3.ab7f762d.js"><link rel="prefetch" href="/assets/js/30.36c529ec.js"><link rel="prefetch" href="/assets/js/31.25ff9a58.js"><link rel="prefetch" href="/assets/js/32.ac3d59d4.js"><link rel="prefetch" href="/assets/js/33.8fcc5bfc.js"><link rel="prefetch" href="/assets/js/34.380b1e1a.js"><link rel="prefetch" href="/assets/js/35.fdcdb841.js"><link rel="prefetch" href="/assets/js/36.04ee9dff.js"><link rel="prefetch" href="/assets/js/37.5cf397c2.js"><link rel="prefetch" href="/assets/js/38.f519aa1c.js"><link rel="prefetch" href="/assets/js/39.6c469b3a.js"><link rel="prefetch" href="/assets/js/4.f548eb01.js"><link rel="prefetch" href="/assets/js/40.a3ab9d1c.js"><link rel="prefetch" href="/assets/js/41.bae83322.js"><link rel="prefetch" href="/assets/js/42.93a06392.js"><link rel="prefetch" href="/assets/js/43.36435a34.js"><link rel="prefetch" href="/assets/js/44.40184c01.js"><link rel="prefetch" href="/assets/js/45.b8757a9d.js"><link rel="prefetch" href="/assets/js/46.39591c26.js"><link rel="prefetch" href="/assets/js/47.8b172743.js"><link rel="prefetch" href="/assets/js/48.8997350b.js"><link rel="prefetch" href="/assets/js/49.a6648243.js"><link rel="prefetch" href="/assets/js/5.c2368b8a.js"><link rel="prefetch" href="/assets/js/50.8fe05c7c.js"><link rel="prefetch" href="/assets/js/51.9b7a16cb.js"><link rel="prefetch" href="/assets/js/52.fc3bc001.js"><link rel="prefetch" href="/assets/js/53.0cc98792.js"><link rel="prefetch" href="/assets/js/54.97c4ca49.js"><link rel="prefetch" href="/assets/js/55.1419c359.js"><link rel="prefetch" href="/assets/js/56.6b5cfcee.js"><link rel="prefetch" href="/assets/js/57.ac197a79.js"><link rel="prefetch" href="/assets/js/58.17d58c97.js"><link rel="prefetch" href="/assets/js/59.d1cf55e9.js"><link rel="prefetch" href="/assets/js/6.d580b911.js"><link rel="prefetch" href="/assets/js/60.bb80cfbb.js"><link rel="prefetch" href="/assets/js/61.68b29800.js"><link rel="prefetch" href="/assets/js/62.aedb920f.js"><link rel="prefetch" href="/assets/js/63.1ddad8da.js"><link rel="prefetch" href="/assets/js/64.9851f72c.js"><link rel="prefetch" href="/assets/js/65.057d49c1.js"><link rel="prefetch" href="/assets/js/66.b0e55974.js"><link rel="prefetch" href="/assets/js/67.09bdeae2.js"><link rel="prefetch" href="/assets/js/68.adc4c6a1.js"><link rel="prefetch" href="/assets/js/69.868a6c8f.js"><link rel="prefetch" href="/assets/js/7.614e87f4.js"><link rel="prefetch" href="/assets/js/70.2e2844e9.js"><link rel="prefetch" href="/assets/js/71.da0ec427.js"><link rel="prefetch" href="/assets/js/72.c4c009c6.js"><link rel="prefetch" href="/assets/js/73.68aa4730.js"><link rel="prefetch" href="/assets/js/74.51b3676b.js"><link rel="prefetch" href="/assets/js/75.cf3b153d.js"><link rel="prefetch" href="/assets/js/76.c75ae3f9.js"><link rel="prefetch" href="/assets/js/77.b3cc53d7.js"><link rel="prefetch" href="/assets/js/78.30576e13.js"><link rel="prefetch" href="/assets/js/79.e4a21c4b.js"><link rel="prefetch" href="/assets/js/8.b2420ac9.js"><link rel="prefetch" href="/assets/js/80.d7f68285.js"><link rel="prefetch" href="/assets/js/81.d5e576dc.js"><link rel="prefetch" href="/assets/js/82.8d80ee18.js"><link rel="prefetch" href="/assets/js/83.9a126314.js"><link rel="prefetch" href="/assets/js/84.7570afae.js"><link rel="prefetch" href="/assets/js/85.599c548d.js"><link rel="prefetch" href="/assets/js/86.522d9a80.js"><link rel="prefetch" href="/assets/js/87.7b431069.js"><link rel="prefetch" href="/assets/js/88.02c77298.js"><link rel="prefetch" href="/assets/js/89.4cecedaa.js"><link rel="prefetch" href="/assets/js/9.9e89bd94.js"><link rel="prefetch" href="/assets/js/90.db7fea0f.js"><link rel="prefetch" href="/assets/js/91.c3784ea8.js"><link rel="prefetch" href="/assets/js/92.d87e6b55.js"><link rel="prefetch" href="/assets/js/93.177b42ae.js"><link rel="prefetch" href="/assets/js/94.986424b1.js"><link rel="prefetch" href="/assets/js/95.fba81753.js"><link rel="prefetch" href="/assets/js/96.05792da0.js"><link rel="prefetch" href="/assets/js/97.751bf4a1.js"><link rel="prefetch" href="/assets/js/98.20caa108.js"><link rel="prefetch" href="/assets/js/99.881ba55a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4f839b66.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="星途物语" class="logo"> <span class="site-name can-hide">星途物语</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/oam" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hdd/" class="nav-link">随手记录</a></li><li class="dropdown-item"><!----> <a href="/fhd/" class="nav-link">故障处理</a></li><li class="dropdown-item"><!----> <a href="/nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/ansible/" class="nav-link">Ansible</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/zabbix/" class="nav-link">Zabbix</a></li><li class="dropdown-item"><!----> <a href="/prometheus/" class="nav-link">Prometheus</a></li><li class="dropdown-item"><!----> <a href="/gitlab/" class="nav-link">GitLab</a></li><li class="dropdown-item"><!----> <a href="/jenkins/" class="nav-link">Jenkins</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/pge" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/shell/" class="nav-link">Shell</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">Python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="瞬记" class="dropdown-title"><a href="/record/" class="link-title">瞬记</a> <span class="title" style="display:none;">瞬记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/qqspace/" class="nav-link">圈圈空间</a></li><li class="dropdown-item"><!----> <a href="/cooking/" class="nav-link">做饭这件事</a></li></ul></div></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/Janzhou1020" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>星途物语</h3> <span>尚记时，记之</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/oam" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hdd/" class="nav-link">随手记录</a></li><li class="dropdown-item"><!----> <a href="/fhd/" class="nav-link">故障处理</a></li><li class="dropdown-item"><!----> <a href="/nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/ansible/" class="nav-link">Ansible</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/zabbix/" class="nav-link">Zabbix</a></li><li class="dropdown-item"><!----> <a href="/prometheus/" class="nav-link">Prometheus</a></li><li class="dropdown-item"><!----> <a href="/gitlab/" class="nav-link">GitLab</a></li><li class="dropdown-item"><!----> <a href="/jenkins/" class="nav-link">Jenkins</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/pge" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/shell/" class="nav-link">Shell</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">Python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="瞬记" class="dropdown-title"><a href="/record/" class="link-title">瞬记</a> <span class="title" style="display:none;">瞬记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/qqspace/" class="nav-link">圈圈空间</a></li><li class="dropdown-item"><!----> <a href="/cooking/" class="nav-link">做饭这件事</a></li></ul></div></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/Janzhou1020" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随手记录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/065133/" class="sidebar-link">QPS优化记录</a></li><li><a href="/pages/fa4845/" class="sidebar-link">阿里云SLB演示</a></li><li><a href="/pages/837e29/" class="sidebar-link">DDOS预防</a></li><li><a href="/pages/923ca5/" class="sidebar-link">Linux内核优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/mysql1/" class="sidebar-link">MySQL5.7安装</a></li><li><a href="/pages/mysql2/" class="sidebar-link">MySQL常用操作语句</a></li><li><a href="/pages/mysql3/" class="sidebar-link">MySQL主从架构实施</a></li><li><a href="/pages/mysql4/" class="sidebar-link">MySQL主主架构实施</a></li><li><a href="/pages/mysql5/" class="sidebar-link">MySQL MHA高可用实施</a></li><li><a href="/pages/mysql6/" class="sidebar-link">MyCat读写分离</a></li><li><a href="/pages/mysql7/" class="sidebar-link">MySQL创建用户时的授权</a></li><li><a href="/pages/mysql8/" class="sidebar-link">MySQL备份</a></li><li><a href="/pages/mysql9/" class="sidebar-link">MySQL通配符</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Nginx学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/nginx1/" class="sidebar-link">状态码含义</a></li><li><a href="/pages/nginx2/" class="sidebar-link">匹配优先级</a></li><li><a href="/pages/nginx3/" class="sidebar-link">Nginx常用操作</a></li><li><a href="/pages/nginx4/" class="sidebar-link">添加第三方模块</a></li><li><a href="/pages/nginx5/" class="sidebar-link">关于路径匹配</a></li><li><a href="/pages/nginx6/" class="sidebar-link">转发和重写</a></li><li><a href="/pages/nginx7/" class="sidebar-link">内置变量</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Tomcat学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/tomcat1/" class="sidebar-link">部署Tomcat</a></li><li><a href="/pages/tomcat2/" class="sidebar-link">修改发布目录</a></li><li><a href="/pages/tomcat3/" class="sidebar-link">Tomcat调优</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/redis1/" class="sidebar-link">通过 tar.gz 包安装部署 redis</a></li><li><a href="/pages/redis2/" class="sidebar-link">redis 配置文件</a></li><li><a href="/pages/redis3/" class="sidebar-link">哨兵集群</a></li><li><a href="/pages/redis4/" class="sidebar-link">redis常用命令</a></li><li><a href="/pages/redis5/" class="sidebar-link">虚拟机安装 redis.tar.gz 遇到的问题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ansible学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ansible1/" class="sidebar-link">部署和使用 ansible</a></li><li><a href="/pages/ansible2/" class="sidebar-link">ansible 自带的密码认证参数</a></li><li><a href="/pages/ansible3/" class="sidebar-link">批量免密操作：批量分发公钥</a></li><li><a href="/pages/ansible4/" class="sidebar-link">配置主机清单</a></li><li><a href="/pages/ansible5/" class="sidebar-link">ansible 小知识</a></li><li><a href="/pages/ansible6/" class="sidebar-link">模块介绍</a></li><li><a href="/pages/ansible7/" class="sidebar-link">剧本</a></li><li><a href="/pages/ansible8/" class="sidebar-link">一键部署 rsync 环境</a></li><li><a href="/pages/ansible9/" class="sidebar-link">批量安装一个tomcat</a></li><li><a href="/pages/ansible10/" class="sidebar-link">批量安装一个nginx</a></li><li><a href="/pages/ansible11/" class="sidebar-link">批量安装 zabbix-agent</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Zabbix学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/zabbix1/" class="sidebar-link">部署 zabbix 服务端、客户端</a></li><li><a href="/pages/zabbix2/" class="sidebar-link">自定义监控</a></li><li><a href="/pages/zabbix3/" class="sidebar-link">触发器</a></li><li><a href="/pages/zabbix4/" class="sidebar-link">监控项类型</a></li><li><a href="/pages/zabbix5/" class="sidebar-link">简单检查模式</a></li><li><a href="/pages/zabbix6/" class="sidebar-link">zabbix web 界面结构信息</a></li><li><a href="/pages/zabbix7/" class="sidebar-link">邮件报警</a></li><li><a href="/pages/zabbix8/" class="sidebar-link">微信报警</a></li><li><a href="/pages/zabbix9/" class="sidebar-link">snmp 监控网络设备</a></li><li><a href="/pages/zabbix10/" class="sidebar-link">部署 zabbix 服务端、客户端</a></li><li><a href="/pages/zabbix11/" class="sidebar-link">jmx 监控 java 应用</a></li><li><a href="/pages/zabbix12/" class="sidebar-link">ipmi 监控硬件</a></li><li><a href="/pages/zabbix13/" class="sidebar-link">自动化注册</a></li><li><a href="/pages/zabbix14/" class="sidebar-link">监控项的主要项和相关项</a></li><li><a href="/pages/zabbix15/" class="sidebar-link">percona 监控 mysql</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Git学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/git1/" class="sidebar-link">配置 git</a></li><li><a href="/pages/git2/" class="sidebar-link">常用命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>GitLab学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/gitlab1/" class="sidebar-link">环境准备</a></li><li><a href="/pages/gitlab2/" class="sidebar-link">安装 gitlab</a></li><li><a href="/pages/gitlab3/" class="sidebar-link">gitlab 忘记 root 管理员密码的处理办法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Jenkins学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/jenkins1/" class="sidebar-link">安装部署</a></li><li><a href="/pages/jenkins2/" class="sidebar-link">jenkins 使用脚本完成项目构建</a></li><li><a href="/pages/jenkins3/" class="sidebar-link">jenkins 自动构建最新项目</a></li><li><a href="/pages/jenkins4/" class="sidebar-link">将 jenkins 自动部署的结果返回给 gitlab</a></li><li><a href="/pages/jenkins5/" class="sidebar-link">jenkins 上线 java 项目</a></li><li><a href="/pages/jenkins6/" class="sidebar-link">jenkins pipeline</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Docker学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/docker1/" class="sidebar-link">安装 docker</a></li><li><a href="/pages/docker2/" class="sidebar-link">配置 docker 源</a></li><li><a href="/pages/docker3/" class="sidebar-link">docker 中的常见名词</a></li><li><a href="/pages/docker4/" class="sidebar-link">镜像管理命令</a></li><li><a href="/pages/docker5/" class="sidebar-link">容器管理命令</a></li><li><a href="/pages/docker6/" class="sidebar-link">创建容器</a></li><li><a href="/pages/docker7/" class="sidebar-link">数据卷</a></li><li><a href="/pages/docker8/" class="sidebar-link">docker network</a></li><li><a href="/pages/docker9/" class="sidebar-link">搭建 LNMP</a></li><li><a href="/pages/docker10/" class="sidebar-link">Dockerfile</a></li><li><a href="/pages/docker11/" class="sidebar-link">Dockerfile 搭建 tomcat</a></li><li><a href="/pages/docker12/" class="sidebar-link">docker 镜像磁盘扩容</a></li><li><a href="/pages/docker13/" class="sidebar-link">docker composer</a></li><li><a href="/pages/docker14/" class="sidebar-link">Harbor 私有镜像仓库</a></li><li><a href="/pages/docker15/" class="sidebar-link">docker 面试题</a></li><li><a href="/pages/docker16/" class="sidebar-link">docker desktop 运行时与虚拟机冲突</a></li></ul></section></li><li><a href="/pages/nexus1/" class="sidebar-link">Nexus学习笔记</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Prometheus学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/prometheus1/" class="sidebar-link">核心组件</a></li><li><a href="/pages/prometheus2/" class="sidebar-link">工作原理</a></li><li><a href="/pages/prometheus3/" class="sidebar-link">安装和配置</a></li><li><a href="/pages/prometheus4/" class="sidebar-link">启动 Prometheus</a></li><li><a href="/pages/prometheus5/" class="sidebar-link">PromQL 使用</a></li><li><a href="/pages/prometheus6/" class="sidebar-link">数据模型</a></li><li><a href="/pages/prometheus7/" class="sidebar-link">Exporter</a></li><li><a href="/pages/prometheus8/" class="sidebar-link">演示服务</a></li><li><a href="/pages/prometheus9/" class="sidebar-link">Grafana 数据可视化</a></li><li><a href="/pages/prometheus10/" aria-current="page" class="active sidebar-link">Prometheus 告警</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/oam/#运维" data-v-06225672>运维</a></li><li data-v-06225672><a href="/oam/#Prometheus学习笔记" data-v-06225672>Prometheus学习笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>星途物语</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-11-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Prometheus 告警<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h3 id="邮件-grafana"><a href="#邮件-grafana" class="header-anchor">#</a> 邮件（Grafana）</h3> <p>Grafana Alerting支持多种告警渠道，比如钉钉，Discord，Email，Kafka，Pushover，Telegram，WebHook等等，我们这里可以使用Email进行展示</p> <p><strong>1.开启告警配置</strong></p> <p>Email是我们最常见的告警接入方式，通过Grafana告警需要在Grafana的配置文件中配饰SMTP服务，在配置/etc/grafana/grafana.ini中，大概在626行，开启告警 820行左右（直接用 / 查找）</p> <p><img src="/img/image-20241228202622676.png" alt="image-20241228202622676" style="zoom:80%;"> <img src="/img/image-20241228202800719.png" alt="image-20241228202800719" style="zoom:80%;">重启Grafana：systemctl restart grafana-server.service</p> <p><strong>2.配置通知渠道（邮件接收者）</strong></p> <p>在不同版本的 Grafana 中这里可能叫法不同</p> <p><img src="/img/image-20241228204342590.png" alt="image-20241228204342590" style="zoom:80%;"><img src="/img/image-20241228204458125.png" alt="image-20241228204458125" style="zoom:80%;"> <img src="/img/image-20241228204827557.png" alt="image-20241228204827557" style="zoom:80%;"></p> <p><img src="/img/image-20241230150931537.png" alt="image-20241230150931537" style="zoom:80%;"><strong>3.添加报警规则</strong></p> <p>但是这里面我们要注意，它并不能识别我们的查询语句中的变量：host，interval 等的信息，那遇到这种情况我们怎么办呢，我们可以复制一条语句然后在下面创建一个新的查询（不用于展示）</p> <p>两点需要注意：</p> <ol><li>新建的查询语句不展示在Panel上</li> <li>查询语句必须是固定的参数，不能是变量</li></ol> <img src="/img/image-20241230093816081.png" alt="image-20241230093816081" style="zoom:80%;"> <img src="/img/image-20241230151112519.png" alt="image-20241230151112519" style="zoom:80%;"> <p>另外，也可以直接去 Dashboard 内创建报警</p> <p><strong>4.设置 Notification policies（报警匹配规则）</strong></p> <p>因为 alert rule（报警规则） 是通过 label 来匹配 contact point（通知策略）</p> <p>所以需要定义一个 Notification policy，给 contact point 定义 label</p> <p><img src="/img/image-20241230162918310.png" alt="image-20241230162918310" style="zoom:80%;"><strong>5.给 alert rules 设置 lable，绑定通知方式</strong></p> <p><img src="/img/image-20241230165501195.png" alt="image-20241230165501195" style="zoom:80%;">接下来对内存进行压测，观察邮件发送</p> <p>dd if=/dev/zero of=/dev/null bs=1G count=102400</p> <p><img src="/img/image-20241230165908012.png" alt="image-20241230165908012" style="zoom:80%;"> <img src="/img/image-20241230165849380.png" alt="image-20241230165849380" style="zoom:80%;"></p> <h3 id="多序列"><a href="#多序列" class="header-anchor">#</a> 多序列</h3> <p>我们经常在监控报警的查询中会返回多个序列，Grafana 的报警中的聚合函数和阈值检测都会去评估每一个序列，但是在 Grafana 目前不会去跟踪每个序列的报警规则状态，所以这会影响到我们的报警结果</p> <p>具体过程：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1.报警返回两个序列 server_1和server_2
2.server_1触发了报警规则并切换到了报警状态
3.发送消息通知出去，比如发送的消息是：负载达到了80%（server_1）
4.如果在同一报警规则的后续评估中，server_2序列也会导致触发了报警
5.这个时候不会发送新的通知，因为报警规则已经处于报警状态之下了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以从上面的场景可以看出，如果规则处于告警状态了，当其序列也达到了报警条件后，Grafana不会发送消息通知，目前Grafana官方有针对多个序列查询的支持，会在未来的版本中跟踪每一个序列的状态，所以目前也是Grafana功能的一个局限性</p> <h3 id="告警模板"><a href="#告警模板" class="header-anchor">#</a> 告警模板</h3> <p>就是一个可以传进来的变量</p> <img src="/img/image-20241231142044087.png" alt="image-20241231142044087" style="zoom:80%;"> <h3 id="pushgateway"><a href="#pushgateway" class="header-anchor">#</a> PushGateway</h3> <p>我们都知道 Prometheus 采集数据使用的是pull的方式，但是在某些网络下（不在一个子网或者防火墙），Prometheus无法直接拉取监控指标数据，这个时候我们就需要一个和能够主动push的模式了，而PushGateway就是Prometheus生态中来解决这个问题的一个
工具</p> <p>但是把PushGateway也不是万能的，其本身也存在一些弊端</p> <ul><li>将多个节点数据汇聚到pushgateway，如果pushgateway挂了，会收到很大范围的影响</li> <li>Prometheus拉取状态up只针对pushgateway无法做到对每个目标有效</li></ul> <p>由于 pushgateway 可以持久化推送给它所有监控数据，所以即使你的监控已下线，Prometheus还会拉取到旧的监控数据，需要手动清理Pushgateway不要的数据</p> <p>下载后启动一下</p> <p><img src="/img/image-20241231153719542.png" alt="image-20241231153719542" style="zoom:80%;">Pushgateway的数据推送支持两种方式：Prometheus Client SDK推送和API推送</p> <p><strong>Client SDK 推送</strong></p> <p>Prometheus本身其实支持了多种语言的SDK，可通过SDK的方式生成相关的数据，并推送到Pushgateway，当然了这种方式需要客户端代码支持，这也是官方推荐的方案，目前SDK支持的语言：Go、Java or Scala、Python、Ruby、Rust</p> <p>当然也有许多的第三方库，详情参考：https://prometheus.io/docs/instrumenting/clientlibs</p> <p>这里我们可以使用Python为例，因为我这里是Python3，所以需要使用pip3 安装一下 prometheus的sdk开发包</p> <p>pip3 install prometheus-client -i &quot;https://mirrors.aliyun.com/pypi/simple&quot;</p> <p>如果有公钥验证：pip3 install prometheus-client --trusted-host mirrors.aliyun.com -i &quot;http://mirrors.aliyun.com/pypi/simple&quot;</p> <p>SDK 示例</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>from prometheus_client import CollectorRegistry, Gauge, push_to_gateway
# 创建一个指标注册表
registry = CollectorRegistry()
# 创建一个 Gauge 指标
g = Gauge('example_metric', 'This is an example metric', registry=registry)
# 设置指标的值
g.set(123.45)
# 推送到 Pushgateway
push_to_gateway('http://localhost:9091', job='example_job', registry=registry)
print(&quot;Metric pushed successfully!&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>运行 python 代码，观察 alertgateway 控制台</p> <img src="/img/image-20241231173525562.png" alt="image-20241231173525562" style="zoom:80%;"> <p><strong>API 推送</strong></p> <p>还可以使用Prometheus文本协议推送指标，无需借助单独的CLI，只需要curl之类的工具即可。不过需要注意的是文本中必须包含(&quot;LF&quot;或者&quot;\n&quot;)来结尾，以其他方式结束一行，例如：&quot;CR&quot; ('r')，'CRLF' ('\r\n')或者只是数据包结尾，将导致协议错误</p> <p>echo &quot;some_metrics 3.14&quot; | curl --data-binary @- http://10.0.0.21:9091/metrics/job/web_requests</p> <p>这里是将数据样本推送到了job名为web_requests的标识组中</p> <img src="/img/image-20241231173930950.png" alt="image-20241231173930950" style="zoom:80%;"> <p>接下来我们推送一个更麻烦点的</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cat &lt;&lt;EOF | curl --data-binary @- http://10.0.0.21:9091/metrics/job/web_requests/instance/web
# TYPE some_metric counter
some_metrics{label=&quot;vall&quot;} 22
# TYPE another_metric gauge
# HELP another_metric Just an example.
another_metric 2991.132
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><img src="/img/image-20241231175220092.png" alt="image-20241231175220092" style="zoom:80%;"> <p>可以看到，虽然是同一个job但是instance是不同的，这个时候他们的数据是不在一起展示的</p> <p>删除指标也非常的简单，这个时候就使用到我们的HTTP 协议中的DELETE了，我们来删除刚刚创建的一个分组</p> <p>curl -X DELETE http://10.0.0.21:9091/metrics/job/web_requests/instance/web</p> <p>需要注意的是，这里的删除是根据分组标识进行删除的比如删除{job=&quot;web_requests&quot;}下的所有指标</p> <p><strong>抓取目标</strong></p> <p>修改 prometheus 的配置文件，发现服务，随后重启 prometheus</p> <img src="/img/image-20250101204242892.png" alt="image-20250101204242892" style="zoom:80%;"> <p>PromQL来查询我们的推送上去的语句
PromQL：some_metrics{job=~'pushgateway'}</p> <p>客观来讲我们的生产中能不使用这个就尽量不要使用这个 pushgateway</p> <img src="/img/image-20250101204611257.png" alt="image-20250101204611257" style="zoom:80%;"> <h3 id="alertmanager"><a href="#alertmanager" class="header-anchor">#</a> AlertManager</h3> <p>前面我们学习了Prometheus的时候了解到了Prometheus包含一个告警模块，也就是我们今天来学的AlertManager，Alertmanager主要用于接收Prometheus发送的告警信息，它支持丰富的告警通知渠道，而且很容易做到告警信息去重，降噪，分组等，是一款非常前卫的告警系统</p> <p>通过在Prometheus中定义告警规则，Prometheus会周期性的对告警策略进行计算，如果满足告警触发条件就会想Alertmanager发送告警信息</p> <h4 id="_1-概念"><a href="#_1-概念" class="header-anchor">#</a> 1.概念</h4> <p>分组（Grouping）</p> <p>Grouping 是 <strong>Alertmanager</strong> 把同类型的警报进行分组，合并多条警报到一个通知中。在生产环境中，特别是云环境下的业务之间密集耦合时，若出现多台 Instance 故障，可能会导致成千上百条警报触发。在这种情况下使用分组机制，可以把这些被触发的警报合并为一个警报进行通知，从而避免瞬间突发性的接受大量警报通知，使得管理员无法对问题进行快速定位</p> <p>举个栗子，在Kubernetes集群中，运行着重量级规模的实例，即便是集群中持续很小一段时间的网络延迟或者延迟导致网络抖动，也会引发大量类似服务应用无法连接 DB 的故障。如果在警报规则中定义每一个应用实例都发送警报，那么到最后的结果就是
会有大量的警报信息发送给 <strong>Alertmanager</strong></p> <p>作为运维组或者相关业务组的开发人员，可能更关心的是在一个通知中就可以快速查看到哪些服务实例被本次故障影响了。为此，我们对服务所在集群或者服务警报名称的维度进行分组配置，把警报汇总成一条通知时，就不会受到警报信息的频繁发送影响了</p> <p>抑制（Inhibition）</p> <p>Inhibition 是 当某条警报已经发送，停止重复发送由此警报引发的其他异常或故障的警报机制</p> <p>在生产环境中，IDC托管机柜中，若每一个机柜接入层仅仅是单台交换机，那么该机柜接入交换机故障会造成机柜中服务器非 up 状态警报。再有服务器上部署的应用服务不可访问也会触发警报</p> <p>这时候，可以通过在 <strong>Alertmanager</strong> 配置忽略由于交换机故障而造成的此机柜中的所有服务器及其应用不可达而产生的警报</p> <p>在我们的灾备体系中，当原有集群故障宕机业务彻底无法访问的时候，会把用户流量切换到备份集群中，这样为故障集群及其提供的各个微服务状态发送警报机会失去了意义，此时， <strong>Alertmanager</strong> 的抑制特性就可以在一定程度上避免管理员收到过多无用的警报通知</p> <p>静默（Silences ）</p> <p>Silences 提供了一个简单的机制，根据标签快速对警报进行静默处理；对传进来的警报进行匹配检查，如果接受到警报符合静默的配置，<strong>Alertmanager</strong> 则不会发送警报通知</p> <p>以上除了分组、抑制是在 <strong>Alertmanager</strong> 配置文件中配置，静默是需要在 WEB UI 界面中设置临时屏蔽指定的警报通知</p> <p>路由（route）</p> <p>用于配置 Alertmanager 如何处理传入的特定类型的告警通知，其基本逻辑是根据路由匹配规则的匹配结果来确定处理当前报警通知的路径和行为</p> <h4 id="_2-配置详解"><a href="#_2-配置详解" class="header-anchor">#</a> 2.配置详解</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token comment"># 经过此时间后，如果尚未更新告警，则将告警声明为已恢复。(即prometheus没有向alertmanager发送告警了)</span>
  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m
  <span class="token comment"># 配置发送邮件信息</span>
  <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'smtp.qq.com:465'</span>
  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">'742899387@qq.com'</span>
  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">'742899387@qq.com'</span>
  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">'password'</span>
  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># 读取告警通知模板的目录。</span>
<span class="token key atrule">templates</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token string">'/etc/alertmanager/template/*.tmpl'</span>

<span class="token comment"># 所有报警都会进入到这个根路由下，可以根据根路由下的子路由设置报警分发策略</span>
<span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token comment"># 先解释一下分组，分组就是将多条告警信息聚合成一条发送，这样就不会收到连续的报警了。</span>
  <span class="token comment"># 将传入的告警按标签分组(标签在prometheus中的rules中定义)，例如：</span>
  <span class="token comment"># 接收到的告警信息里面有许多具有cluster=A 和 alertname=LatencyHigh的标签，这些个告警将被分为一个组。</span>
  <span class="token comment"># 如果不想使用分组，可以这样写group_by: [...]</span>
  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">,</span> <span class="token string">'cluster'</span><span class="token punctuation">,</span> <span class="token string">'service'</span><span class="token punctuation">]</span>
  <span class="token comment"># 第一组告警发送通知需要等待的时间，这种方式可以确保有足够的时间为同一分组获取多个告警，然后一起触发这个告警信息。</span>
  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s
  <span class="token comment"># 发送第一个告警后，等待&quot;group_interval&quot;发送一组新告警。</span>
  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 5m
  <span class="token comment"># 分组内发送相同告警的时间间隔。这里的配置是每3小时发送告警到分组中。举个例子：收到告警后，一个分组被创建，等待5分钟发送组内告警，如果后续组内的告警信息相同,这些告警会在3小时后发送，但是3小时内这些告警不会被发送。</span>
  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 3h
  <span class="token comment"># 这里先说一下，告警发送是需要指定接收器的，接收器在receivers中配置，接收器可以是email、webhook、pagerduty、wechat等等。一个接收器可以有多种发送方式。</span>
  <span class="token comment"># 指定默认的接收器</span>
  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>X<span class="token punctuation">-</span>mails
  <span class="token comment"># 下面配置的是子路由，子路由的属性继承于根路由(即上面的配置)，在子路由中可以覆盖根路由的配置</span>
  <span class="token comment"># 下面是子路由的配置</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
  <span class="token comment"># 使用正则的方式匹配告警标签</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match_re</span><span class="token punctuation">:</span>
      <span class="token comment"># 这里可以匹配出标签含有service=foo1或service=foo2或service=baz的告警</span>
      <span class="token key atrule">service</span><span class="token punctuation">:</span> ^(foo1<span class="token punctuation">|</span>foo2<span class="token punctuation">|</span>baz)$
    <span class="token comment"># 指定接收器为team-X-mails</span>
    <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>X<span class="token punctuation">-</span>mails
    <span class="token comment"># 这里配置的是子路由的子路由，当满足父路由的的匹配时，这条子路由会进一步匹配出severity=critical的告警，并使用team-X-pager接收器发送告警，没有匹配到的告警会由父路由进行处理。</span>
    <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
        <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
      <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>X<span class="token punctuation">-</span>pager

  <span class="token comment"># 这里也是一条子路由，会匹配出标签含有service=files的告警，并使用team-Y-mails接收器发送告警</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
      <span class="token key atrule">service</span><span class="token punctuation">:</span> files
    <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>Y<span class="token punctuation">-</span>mails
    <span class="token comment"># 这里配置的是子路由的子路由，当满足父路由的的匹配时，这条子路由会进一步匹配出severity=critical的告警，并使用team-Y-pager接收器发送告警，没有匹配到的会由父路由进行处理。</span>
    <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
        <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
      <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>Y<span class="token punctuation">-</span>pager

  <span class="token comment"># 该路由处理来自数据库服务的所有警报。如果没有团队来处理，则默认为数据库团队。</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
      <span class="token comment"># 首先匹配标签service=database</span>
      <span class="token key atrule">service</span><span class="token punctuation">:</span> database
    <span class="token comment"># 指定接收器</span>
    <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>DB<span class="token punctuation">-</span>pager
    <span class="token comment"># 根据受影响的数据库对告警进行分组</span>
    <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>alertname<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> database<span class="token punctuation">]</span>
    <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>X
      <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>X<span class="token punctuation">-</span>pager
      <span class="token comment"># 告警是否继续匹配后续的同级路由节点，默认false，下面如果也可以匹配成功，会向两种接收器都发送告警信息(猜测。。。)</span>
      <span class="token key atrule">continue</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>Y
      <span class="token key atrule">receiver</span><span class="token punctuation">:</span> team<span class="token punctuation">-</span>Y<span class="token punctuation">-</span>pager


<span class="token comment"># 下面是关于inhibit(抑制)的配置，先说一下抑制是什么：抑制规则允许在另一个警报正在触发的情况下使一组告警静音。其实可以理解为告警依赖。比如一台数据库服务器掉电了，会导致db监控告警、网络告警等等，可以配置抑制规则如果服务器本身down了，那么其他的报警就不会被发送出来。</span>

<span class="token key atrule">inhibit_rules</span><span class="token punctuation">:</span>
<span class="token comment">#下面配置的含义：当有多条告警在告警组里时，并且他们的标签alertname,cluster,service都相等，如果severity: 'critical'的告警产生了，那么就会抑制severity: 'warning'的告警。</span>
<span class="token punctuation">-</span> <span class="token key atrule">source_match</span><span class="token punctuation">:</span>  <span class="token comment"># 源告警(我理解是根据这个报警来抑制target_match中匹配的告警)</span>
    <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'critical'</span> <span class="token comment"># 标签匹配满足severity=critical的告警作为源告警</span>
  <span class="token key atrule">target_match</span><span class="token punctuation">:</span>  <span class="token comment"># 目标告警(被抑制的告警)</span>
    <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'warning'</span>  <span class="token comment"># 告警必须满足标签匹配severity=warning才会被抑制。</span>
  <span class="token key atrule">equal</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">,</span> <span class="token string">'cluster'</span><span class="token punctuation">,</span> <span class="token string">'service'</span><span class="token punctuation">]</span>  <span class="token comment"># 必须在源告警和目标告警中具有相等值的标签才能使抑制生效。(即源告警和目标告警中这三个标签的值相等'alertname', 'cluster', 'service')</span>


<span class="token comment"># 下面配置的是接收器</span>
<span class="token key atrule">receivers</span><span class="token punctuation">:</span>
<span class="token comment"># 接收器的名称、通过邮件的方式发送、</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'team-X-mails'</span>
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
    <span class="token comment"># 发送给哪些人</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'team-X+alerts@example.org'</span>
    <span class="token comment"># 是否通知已解决的警报</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment"># 接收器的名称、通过邮件和pagerduty的方式发送、发送给哪些人，指定pagerduty的service_key</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'team-X-pager'</span>
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'team-X+alerts-critical@example.org'</span>
  <span class="token key atrule">pagerduty_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">service_key</span><span class="token punctuation">:</span> &lt;team<span class="token punctuation">-</span>X<span class="token punctuation">-</span>key<span class="token punctuation">&gt;</span>

<span class="token comment"># 接收器的名称、通过邮件的方式发送、发送给哪些人</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'team-Y-mails'</span>
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'team-Y+alerts@example.org'</span>

<span class="token comment"># 接收器的名称、通过pagerduty的方式发送、指定pagerduty的service_key</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'team-Y-pager'</span>
  <span class="token key atrule">pagerduty_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">service_key</span><span class="token punctuation">:</span> &lt;team<span class="token punctuation">-</span>Y<span class="token punctuation">-</span>key<span class="token punctuation">&gt;</span>

<span class="token comment"># 一个接收器配置多种发送方式</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'ops'</span>
  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://prometheus-webhook-dingtalk.kube-ops.svc.cluster.local:8060/dingtalk/webhook1/send'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'742899387@qq.com'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'soulchild@soulchild.cn'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br></div></div><p>实际配置示例</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">## Alertmanager 配置文件</span>
<span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m
  <span class="token comment"># smtp配置</span>
  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">&quot;123456789@qq.com&quot;</span>
  <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'smtp.qq.com:465'</span>
  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">&quot;123456789@qq.com&quot;</span>
  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">&quot;auth_pass&quot;</span>
  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token comment"># email、企业微信的模板配置存放位置，钉钉的模板会单独讲如果配置。</span>
<span class="token key atrule">templates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">'/data/alertmanager/templates/*.tmpl'</span>
<span class="token comment"># 路由分组</span>
<span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> ops
  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s <span class="token comment"># 在组内等待所配置的时间，如果同组内，30秒内出现相同报警，在一个组内出现。</span>
  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 5m <span class="token comment"># 如果组内内容不变化，合并为一条警报信息，5m后发送。</span>
  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 24h <span class="token comment"># 发送报警间隔，如果指定时间内没有修复，则重新发送报警。</span>
  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>alertname<span class="token punctuation">]</span>  <span class="token comment"># 报警分组</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">team</span><span class="token punctuation">:</span> operations
        <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>env<span class="token punctuation">,</span>dc<span class="token punctuation">]</span>
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'ops'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match_re</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span> nginx<span class="token punctuation">|</span>apache
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'web'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match_re</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span> hbase<span class="token punctuation">|</span>spark
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'hadoop'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match_re</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span> mysql<span class="token punctuation">|</span>mongodb
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'db'</span>
<span class="token comment"># 接收器</span>
<span class="token comment"># 抑制测试配置</span>
      <span class="token punctuation">-</span> <span class="token key atrule">receiver</span><span class="token punctuation">:</span> ops
        <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 10s
        <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">'High'</span>
<span class="token comment"># ops</span>
      <span class="token punctuation">-</span> <span class="token key atrule">receiver</span><span class="token punctuation">:</span> ops <span class="token comment"># 路由和标签，根据match来指定发送目标，如果 rule的lable 包含 alertname， 使用 ops 来发送</span>
        <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 10s
        <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">team</span><span class="token punctuation">:</span> operations
<span class="token comment"># web</span>
      <span class="token punctuation">-</span> <span class="token key atrule">receiver</span><span class="token punctuation">:</span> db <span class="token comment"># 路由和标签，根据match来指定发送目标，如果 rule的lable 包含 alertname， 使用 db 来发送</span>
        <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 10s
        <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">team</span><span class="token punctuation">:</span> db
<span class="token comment"># 接收器指定发送人以及发送渠道</span>
<span class="token key atrule">receivers</span><span class="token punctuation">:</span>
<span class="token comment"># ops分组的定义</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ops
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'9935226@qq.com,10000@qq.com'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token key atrule">subject</span><span class="token punctuation">:</span> <span class="token string">&quot;[operations] 报警邮件&quot;</span>
      <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token string">&quot;警报中心&quot;</span>
      <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">&quot;小煜狼皇&quot;</span>
  <span class="token comment"># 钉钉配置</span>
  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8070/dingtalk/ops/send
    <span class="token comment"># 企业微信配置</span>
  <span class="token key atrule">wechat_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">corp_id</span><span class="token punctuation">:</span> <span class="token string">'ww5421dksajhdasjkhj'</span>
    <span class="token key atrule">api_url</span><span class="token punctuation">:</span> <span class="token string">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">to_party</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
    <span class="token key atrule">agent_id</span><span class="token punctuation">:</span> <span class="token string">'1000002'</span>
    <span class="token key atrule">api_secret</span><span class="token punctuation">:</span> <span class="token string">'Tm1kkEE3RGqVhv5hO-khdakjsdkjsahjkdksahjkdsahkj'</span>

<span class="token comment"># web</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'9935226@qq.com'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> <span class="token string">&quot;[web] 报警邮件&quot;</span><span class="token punctuation">}</span> <span class="token comment"># 接收邮件的标题</span>
  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8070/dingtalk/web/send
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8070/dingtalk/ops/send
<span class="token comment"># db</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'9935226@qq.com'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> <span class="token string">&quot;[db] 报警邮件&quot;</span><span class="token punctuation">}</span> <span class="token comment"># 接收邮件的标题</span>
  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8070/dingtalk/db/send
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8070/dingtalk/ops/send
<span class="token comment"># hadoop</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hadoop
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'9935226@qq.com'</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> <span class="token string">&quot;[hadoop] 报警邮件&quot;</span><span class="token punctuation">}</span> <span class="token comment"># 接收邮件的标题</span>
  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8070/dingtalk/hadoop/send
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8070/dingtalk/ops/send

<span class="token comment"># 抑制器配置</span>
<span class="token key atrule">inhibit_rules</span><span class="token punctuation">:</span> <span class="token comment"># 抑制规则</span>
  <span class="token punctuation">-</span> <span class="token key atrule">source_match</span><span class="token punctuation">:</span> <span class="token comment"># 源标签警报触发时抑制含有目标标签的警报，在当前警报匹配 status: 'High'</span>
      <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">'High'</span>  <span class="token comment"># 此处的抑制匹配一定在最上面的route中配置不然，会提示找不key。</span>
    <span class="token key atrule">target_match</span><span class="token punctuation">:</span>
      <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">'Warning'</span> <span class="token comment"># 目标标签值正则匹配，可以是正则表达式如: &quot;.*MySQL.*&quot;</span>
    <span class="token key atrule">equal</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">,</span><span class="token string">'operations'</span><span class="token punctuation">,</span> <span class="token string">'instance'</span><span class="token punctuation">]</span> <span class="token comment"># 确保这个配置下的标签内容相同才会抑制，也就是说警报中必须有这三个标签值才会被抑制。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div><p><strong>global</strong></p> <p>为全局设置，在 <strong>Alertmanager</strong> 配置文件中，只要全局设置配置了的选项，全部为公共设置，可以让其他设置继承，作为默认值，可以子参数中覆盖其设置。其中 resolve_timeout 用于设置处理超时时间，也是生命警报状态为解决的时间，这个时间会直接影响到警报恢复的通知时间，需要自行结合实际生产场景来设置主机的恢复时间，默认是5分钟。在全局设置中可以设置smtp服务，同时也支持slack、victorops、pagerduty等，在这里只讲我们常用的Email，钉钉，企业微信，同时也可以自己使用go语言开发的gubot进行二次开发，对接自定义webhook通知源</p> <p><strong>template</strong></p> <p>警报模板可以自定义通知的信息格式，以及其包含的对应警报指标数据，可以自定义Email、企业微信的模板，配置指定的存放位置，对于钉钉的模板会单独讲如何配置，这里的模板是指的发送的通知源信息格式模板，比如Email，企业微信</p> <p><strong>route</strong></p> <p>警报路由模块描述了在收到 <strong>Prometheus</strong> 生成的警报后，将警报信息发送给接收器 receiver 指定的目标地址规则。 <strong>Alertmanager</strong> 对传入的警报信息进行处理，根据所定义的规则与配置进行匹配。对于路由可以理解为树状结构，设置的第一个route是跟节点，往下的就是包含的子节点，每个警报传进来以后，会从配置的跟节点路由进入路由树，按照深度优先从左向右遍历匹配，当匹配的节点后停止，进行警报处理</p> <table><thead><tr><th>参数</th> <th>描述</th></tr></thead> <tbody><tr><td>receiver: &lt;string&gt;</td> <td>发送警报的接收器名称</td></tr> <tr><td>group_by: ['label_name1,...']</td> <td>根据 prometheus 的 lables 进行报警分组，这些警报会合并为一个通知发送给接收器，也就是警报分组</td></tr> <tr><td>match: [ &lt;label_name&gt;: &lt;labelvalue&gt;,...]</td> <td>通过此设置来判断当前警报中是否有标签的labelname，等同于labelvalue</td></tr> <tr><td>match_re: [&lt;label_name&gt;: &lt;regex&gt;,...]</td> <td>通过正则表达式进行警报配置</td></tr> <tr><td>group_wait: [&lt;duration&gt;]</td> <td>设置从接受警报到发送的等待时间，若在等待时间中group接收到新的警报信息，这些警报会合并为一条发送，默认30s</td></tr> <tr><td>group_interval: [&lt;duration&gt;]</td> <td>此设置控制的是 group 之间发送警报通知的间隔时间，默认5m</td></tr> <tr><td>repeat_interval: [&lt;duration&gt;]</td> <td>此设置控制的是警报发送成功以后，没有对警报做解决操作的话，状态 Firing 没有变成 Inactive 或者 Pending ，会再次发送警报的的间隔时间，默认4h</td></tr> <tr><td>routes: - &lt;route&gt;...</td> <td></td></tr></tbody></table> <p>路由匹配规则示例</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> admin <span class="token comment"># 默认的接收器名称</span>
  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s <span class="token comment"># 在组内等待所配置的时间，如果同组内，30秒内出现相同报警，在一个组内出现。</span>
  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 5m <span class="token comment"># 如果组内内容不变化，5m后发送。</span>
  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 24h <span class="token comment"># 发送报警间隔，如果指定时间内没有修复，则重新发送报警</span>
  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>alertname<span class="token punctuation">,</span>cluster<span class="token punctuation">]</span>  <span class="token comment"># 报警分组，根据 prometheus 的 lables 进行报警分组，这些警报会合并为一个通知发送给接收器，也就是警报分组。</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">team</span><span class="token punctuation">:</span> ops
        <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>env<span class="token punctuation">,</span>dc<span class="token punctuation">]</span>
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'ops'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match_re</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span> nginx<span class="token punctuation">|</span>apache
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'web'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match_re</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span> mysql<span class="token punctuation">|</span>mongodb
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'db'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match_re</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span> hbase<span class="token punctuation">|</span>spark
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'hadoop'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在以上的例子中，默认的警报组全部发送给 admin ，且根据路由按照 alertname cluster 进行警报分组。在子路由中的若匹配警报中的标签 team 的值为 ops，Alertmanager 会按照标签 env dc 进行警报分组然后发送给接收器 receiver ops配置的警报通知源，继续匹配的操作是对 service 标签进行匹配，并且配到了 nginx redis mongodb 的值，就会向接收器 receiver web配置的警报通知源发送警报信息</p> <p>对这种匹配验证操作灰常考究个人的逻辑思维能力，这不是人干的事情呀~因此，Prometheus发布了一个 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.prometheus.io%2Fwebtools%2Falerting%2Frouting-tree-editor%2F" target="_blank" rel="noopener noreferrer">Routing tree editor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，用于检测Alertmanager的配置文件结构配置信息，然后调试。使用方法很简单，就是把 alertmanager.yml 的配置信心复制到这个站点，然后点击 Draw Routing Tree 按钮生成路由结构树，然后在 Match Label Set 前面输入以 {&lt;label name&gt; = &quot;&lt;value&gt;&quot;} 格式的警报标签，然后点击 Match Label Set 按钮会显示发送状态图</p> <p>https://www.prometheus.io/webtools/alerting/routing-tree-editor/</p> <p>然后我们可以使用 {service=&quot;nginx&quot;} 和 {service=&quot;mysql&quot;} 表达式来做匹配的规则用于验证其发送通知源是否为 receiver 中 web/db 的发送配置</p> <p><img src="/img/image-20250103141338174.png" alt="image-20250103141338174" style="zoom:50%;"><strong>receiver 接收器</strong></p> <p>接受器是一个统称，每个 receiver 都有需要设置一个全局唯一的名称，并且对应一个或者多个通知方式，包括email、微信、Slack、钉钉等</p> <p>官方现在满足的配置是：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">&gt;</span>
<span class="token key atrule">email_config</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> <span class="token punctuation">-</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">hipchat_configs</span><span class="token punctuation">:</span> <span class="token comment">#此模块配置已经被移除了</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">pagerduty_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">pushover_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">slack_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">opsgenie_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">victorops_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
<span class="token key atrule">webchat_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">[</span> &lt;config<span class="token punctuation">&gt;</span> <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>可以看到Alertmanager提供了很多种接收器的通知配置，我们可以使用webhook接收器来定义通知集成，支持用户自己定义编写</p> <p><strong>inhibit_rules 抑制器</strong></p> <p>inhibit_rules 模块中设置警报抑制功能，可以指定在特定条件下需要忽略的警报条件。可以使用此选项设置首选，比如优先处理某些警报，如果同一组中的警报同时发生，则忽略其他警报，合理使用 inhibit_rules ，可以减少频发发送没有意义的警报的产生</p> <p>inhibit_rules 配置信息</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">trget_match</span><span class="token punctuation">:</span>
     <span class="token punctuation">[</span> <span class="token key atrule">&lt;label_name&gt;</span><span class="token punctuation">:</span> &lt;labelvalue<span class="token punctuation">&gt;</span><span class="token punctuation">,</span><span class="token punctuation">...</span> <span class="token punctuation">]</span>
<span class="token key atrule">trget_match_re</span><span class="token punctuation">:</span>
     <span class="token punctuation">[</span> <span class="token key atrule">&lt;label_name&gt;</span><span class="token punctuation">:</span> &lt;labelvalue<span class="token punctuation">&gt;</span><span class="token punctuation">,</span><span class="token punctuation">...</span> <span class="token punctuation">]</span>
<span class="token key atrule">source_match</span><span class="token punctuation">:</span>
     <span class="token punctuation">[</span> <span class="token key atrule">&lt;label_name&gt;</span><span class="token punctuation">:</span> &lt;labelvalue<span class="token punctuation">&gt;</span><span class="token punctuation">,</span><span class="token punctuation">...</span> <span class="token punctuation">]</span>
<span class="token key atrule">source_match_re</span><span class="token punctuation">:</span>
     <span class="token punctuation">[</span> <span class="token key atrule">&lt;label_name&gt;</span><span class="token punctuation">:</span> &lt;labelvalue<span class="token punctuation">&gt;</span><span class="token punctuation">,</span><span class="token punctuation">...</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token key atrule">equal</span><span class="token punctuation">:</span> '<span class="token punctuation">[</span><span class="token string">' &lt;lable_name&gt;, ...]'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_3-警报接收通知器"><a href="#_3-警报接收通知器" class="header-anchor">#</a> 3.警报接收通知器</h4> <h5 id="_3-1-email"><a href="#_3-1-email" class="header-anchor">#</a> 3.1 Email</h5> <p><strong>在 prometheus 中配置发现 alertmanager 规则</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">rule_files</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;alert.rules.yml&quot;</span>  <span class="token comment"># 自己创建下这个文件</span>

<span class="token key atrule">alerting</span><span class="token punctuation">:</span>
  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;10.0.0.21:9093&quot;</span><span class="token punctuation">]</span>  <span class="token comment"># Alertmanager 的地址</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>在 alert.rules.yml 中添加告警规则</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> memory_alert
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighMemoryUsage
        <span class="token key atrule">expr</span><span class="token punctuation">:</span> (node_memory_MemTotal_bytes <span class="token punctuation">-</span> node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 <span class="token punctuation">&gt;</span> 80
        <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
        <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
          <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">&quot;内存使用率高&quot;</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;内存使用率已达到 {{ $value }}%&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>alertmanager 配置如下</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m
  <span class="token comment"># smtp配置</span>
  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">&quot;156xxxx2568@163.com&quot;</span> <span class="token comment"># 发送邮件主题</span>
  <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'smtp.163.com:465'</span> <span class="token comment"># 邮箱服务器的SMTP主机配置</span>
  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">&quot;156xxxx2568@163.com&quot;</span> <span class="token comment"># 登录用户名</span>
  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">&quot;BMxxxx6uhxxxxVLk&quot;</span> <span class="token comment"># 此处的auth password是邮箱的第三方登录授权密码，而非用户密码，尽量用QQ来测试。</span>
  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 有些邮箱需要开启此配置，这里使用的是163邮箱，仅做测试，不需要开启此功能。</span>
<span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> email<span class="token punctuation">-</span>alert
  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s <span class="token comment"># 在组内等待所配置的时间，如果同组内，30秒内出现相同报警，在一个组内出现。</span>
  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 5m <span class="token comment"># 如果组内内容不变化，合并为一条警报信息，5m后发送。</span>
  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 1h <span class="token comment"># 发送报警间隔，如果指定时间内没有修复，则重新发送报警。</span>
  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>alertname<span class="token punctuation">]</span>  <span class="token comment"># 报警分组</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'email-alert'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">receiver</span><span class="token punctuation">:</span> email<span class="token punctuation">-</span>alert <span class="token comment"># 路由和标签，根据match来指定发送目标，如果 rule的lable 包含 alertname， 使用 ops 来发送</span>
        <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 10s
        <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
<span class="token comment"># 接收器指定发送人以及发送渠道</span>
<span class="token key atrule">receivers</span><span class="token punctuation">:</span>
<span class="token comment"># ops分组的定义</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> email<span class="token punctuation">-</span>alert
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'156xxxx2568@163.com'</span> <span class="token comment"># 如果想发送多个人就以 ','做分割，写多个邮件人即可。</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token key atrule">subject</span><span class="token punctuation">:</span> <span class="token string">&quot;[operations] 报警邮件&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><strong>重启服务 prometheus 和 alertmanager</strong></p> <p>对内存进行压测：dd if=/dev/zero of=/dev/null bs=1G count=102400</p> <p>报警短信如下</p> <p><img src="/img/image-20250103171338208.png" alt="image-20250103171338208" style="zoom:50%;">恢复短信如下</p> <p><img src="/img/image-20250103171643533.png" alt="image-20250103171643533" style="zoom:50%;"><strong>使用模板来自定义通知</strong></p> <p>模板如下</p> <div class="language-tmpl line-numbers-mode"><pre class="language-text"><code>{{ define &quot;email.html&quot; }}
{{- if gt (len .Alerts.Firing) 0 -}}{{ range .Alerts }}
&lt;h2&gt;@告警通知&lt;/h2&gt;
告警程序: prometheus_alert &lt;br&gt;
告警级别: {{ .Labels.severity }} 级 &lt;br&gt;
告警类型: {{ .Labels.alertname }} &lt;br&gt;
故障主机: {{ .Labels.instance }} &lt;br&gt;
告警主题: {{ .Annotations.summary }} &lt;br&gt;
告警详情: {{ .Annotations.description }} &lt;br&gt;
触发时间: {{ .StartsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }} &lt;br&gt;
{{ end }}{{ end -}}
{{- if gt (len .Alerts.Resolved) 0 -}}{{ range .Alerts }}
&lt;h2&gt;@告警恢复&lt;/h2&gt;
告警程序: prometheus_alert &lt;br&gt;
故障主机: {{ .Labels.instance }} &lt;br&gt;
故障主题: {{ .Annotations.summary }} &lt;br&gt;
告警详情: {{ .Annotations.description }} &lt;br&gt;
告警时间: {{ .StartsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }} &lt;br&gt;
恢复时间: {{ .EndsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }}&lt;br&gt;
{{ end }}{{ end -}}
{{- end }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>在 alertmanager 中导入此模板，在 receivers 中使用模板信息</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">templates</span><span class="token punctuation">:</span>   <span class="token comment">#定义微信告警内容模板</span>
  <span class="token punctuation">-</span> <span class="token string">'/opt/alertmanager/alertmanager/*.tmpl'</span>
<span class="token key atrule">receivers</span><span class="token punctuation">:</span>
<span class="token comment"># ops分组的定义</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> email<span class="token punctuation">-</span>alert
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'15xxxxx568@163.com'</span> <span class="token comment"># 如果想发送多个人就以 ','做分割，写多个邮件人即可。</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token key atrule">subject</span><span class="token punctuation">:</span> <span class="token string">&quot;[operations] 报警邮件&quot;</span>
    <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token string">'{{ template &quot;email.html&quot; . }}'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>重新加载配置文件信息：curl -X POST http://localhost:9093/-/reload</p> <p><img src="/img/07435ab9f93426f4b075fb75f387385.jpg" alt="07435ab9f93426f4b075fb75f387385" style="zoom:15%;"><img src="/img/df0929875580e7333ed300b4b4c7e82.jpg" alt="df0929875580e7333ed300b4b4c7e82" style="zoom:15%;"></p> <h5 id="_3-2-企业微信"><a href="#_3-2-企业微信" class="header-anchor">#</a> 3.2 企业微信</h5> <p>prometheus -- alertmanager -- prometheus-webhook-wechat-main -- 企业微信</p> <p>首先你要具有企业微信管理员的权限，如果没有可以自己注册一个，进行测试，我这里有自行注册的企业微信</p> <p>具体创建过程省略</p> <p>1.第一种方式是通过企业机器人实现报警，但是需要配置实际域名等，如果只是做测试，这种方式用不了。主要是需要获取到1.企业ID，2.告警部门ID，3.机器人ID，4.机器人密钥</p> <p>2.第二种方式是通过企业微信群创建机器人，获取机器人的 webhook 进行配置</p> <p>这里采用第二种方式进行演示</p> <p><strong>1.获取 weebhook</strong></p> <p><img src="/img/image-20250104134902086.png" alt="image-20250104134902086" style="zoom:80%;"><strong>2.启动 go 应用：prometheus-webhook-wechat-main</strong></p> <p>企业微信 webhook 需要用到这个工具</p> <p>下载地址：https://github.com/SecurityNeo/prometheus-webhook-wechat</p> <p>文件种提供了 Dockerfile，也可以用 docker 部署，这里选择直接启用这个应用</p> <p>vim config.yml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">maxContentLength</span><span class="token punctuation">:</span> <span class="token number">4096</span>
<span class="token key atrule">targets</span><span class="token punctuation">:</span>
  <span class="token key atrule">webhook1</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> xxx <span class="token comment"># 填上前面的 Webhook 地址</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们再到 ./cmd/main.go 中查看下项目访问路径，这里可以看到是：/wechat/webhook/send，等一下会用到</p> <p><img src="/img/image-20250104195315993.png" alt="image-20250104195315993" style="zoom:80%;">启动应用：nohup ./prometheus-webhook-wechat --listen-port=':9999' &amp;，这里设置了访问端口为 9999，默认为 80</p> <p><strong>3.配置 alertmanager.yml</strong></p> <p>主要是配置路由和接收器，以下是我做测试的例子</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m
  <span class="token comment"># smtp配置</span>
  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">&quot;156xxxx2568@163.com&quot;</span> <span class="token comment"># 发送邮件主题</span>
  <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'smtp.163.com:465'</span> <span class="token comment"># 邮箱服务器的SMTP主机配置</span>
  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">&quot;156xxxx2568@163.com&quot;</span> <span class="token comment"># 登录用户名</span>
  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">&quot;BMqQpxxxxxxiUqVLk&quot;</span> <span class="token comment"># 此处的auth password是邮箱的第三方登录授权密码，而非用户密码，尽量用QQ来测试。</span>
  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 有些邮箱需要开启此配置，这里使用的是163邮箱，仅做测试，不需要开启此功能。</span>

<span class="token key atrule">templates</span><span class="token punctuation">:</span>                                                                              <span class="token comment">#定义微信告警内容模板</span>
  <span class="token punctuation">-</span> <span class="token string">'/opt/alertmanager/alertmanager/wechat.tmpl'</span>

<span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> email<span class="token punctuation">-</span>alert
  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s <span class="token comment"># 在组内等待所配置的时间，如果同组内，30秒内出现相同报警，在一个组内出现。</span>
  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 5m <span class="token comment"># 如果组内内容不变化，合并为一条警报信息，5m后发送。</span>
  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 1h <span class="token comment"># 发送报警间隔，如果指定时间内没有修复，则重新发送报警。</span>
  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>alertname<span class="token punctuation">]</span>  <span class="token comment"># 报警分组</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
        <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'wechat-webhook'</span>
<span class="token comment"># 接收器指定发送人以及发送渠道</span>
<span class="token key atrule">receivers</span><span class="token punctuation">:</span>
<span class="token comment"># ops分组的定义</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> email<span class="token punctuation">-</span>alert
  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'156xxxx2568@163.com'</span> <span class="token comment"># 如果想发送多个人就以 ','做分割，写多个邮件人即可。</span>
    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token key atrule">subject</span><span class="token punctuation">:</span> <span class="token string">&quot;[operations] 报警邮件&quot;</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'wechat'</span>
  <span class="token key atrule">wechat_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">corp_id</span><span class="token punctuation">:</span> <span class="token string">'ww982xxxxxx442eea'</span>
      <span class="token key atrule">to_party</span><span class="token punctuation">:</span> <span class="token string">'1'</span>
      <span class="token key atrule">agent_id</span><span class="token punctuation">:</span> <span class="token string">'100xxx4'</span>
      <span class="token key atrule">api_secret</span><span class="token punctuation">:</span> <span class="token string">'18gWU4T9PKv-KAhIxxxxxKCbXopyDAWE'</span>
      <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">'{{ template &quot;wechat.default.message&quot; . }}'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'wechat-webhook'</span>
  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">&quot;http://10.0.0.20:9999/wechat/webhook/send&quot;</span>
      <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否发送恢复通知</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>其中最重要是就是在配置 receivers 时用到刚刚的路径：http://10.0.0.20:9999/wechat/webhook/send</p> <p><strong>4.配置通知模板</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> define &quot;__subject&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Status <span class="token punctuation">|</span> toUpper <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> if eq .Status &quot;firing&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Alerts.Firing <span class="token punctuation">|</span> len <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>


<span class="token punctuation">{</span><span class="token punctuation">{</span> define &quot;__alert_list&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> range . <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警主题**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Annotations.summary <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警类型**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Labels.alertname <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警级别**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Labels.severity <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警实例**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Labels.instance <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警内容**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> index .Annotations &quot;description&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警来源**:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .GeneratorURL <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>(<span class="token punctuation">{</span><span class="token punctuation">{</span> .GeneratorURL <span class="token punctuation">}</span><span class="token punctuation">}</span>)
<span class="token punctuation">&gt;</span><span class="token important">**告警时间**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .StartsAt.Local.Format &quot;2006<span class="token punctuation">-</span>01<span class="token punctuation">-</span>02 15<span class="token punctuation">:</span>04<span class="token punctuation">:</span>05&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span> define &quot;__resolved_list&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> range . <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警主题**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Annotations.summary <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警类型**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Labels.alertname <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警级别**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Labels.severity <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警实例**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Labels.instance <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警内容**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> index .Annotations &quot;description&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**告警来源**:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .GeneratorURL <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>(<span class="token punctuation">{</span><span class="token punctuation">{</span> .GeneratorURL <span class="token punctuation">}</span><span class="token punctuation">}</span>)
<span class="token punctuation">&gt;</span><span class="token important">**告警时间**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .StartsAt.Local.Format &quot;2006<span class="token punctuation">-</span>01<span class="token punctuation">-</span>02 15<span class="token punctuation">:</span>04<span class="token punctuation">:</span>05&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">&gt;</span><span class="token important">**恢复时间**:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .EndsAt.Local.Format &quot;2006<span class="token punctuation">-</span>01<span class="token punctuation">-</span>02 15<span class="token punctuation">:</span>04<span class="token punctuation">:</span>05&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>


<span class="token punctuation">{</span><span class="token punctuation">{</span> define &quot;msg.title&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;__subject&quot; . <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span> define &quot;msg.content&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> if gt (len .Alerts.Firing) 0 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token important">**产生&lt;font</span> color=&quot;warning&quot;<span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Alerts.Firing <span class="token punctuation">|</span> len  <span class="token punctuation">}</span><span class="token punctuation">}</span>&lt;/font<span class="token punctuation">&gt;</span>个故障<span class="token important">**</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;__alert_list&quot; .Alerts.Firing <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span> if gt (len .Alerts.Resolved) 0 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token important">**恢复&lt;font</span> color=&quot;info&quot;<span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Alerts.Resolved <span class="token punctuation">|</span> len  <span class="token punctuation">}</span><span class="token punctuation">}</span>&lt;/font<span class="token punctuation">&gt;</span>个故障<span class="token important">**</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;__resolved_list&quot; .Alerts.Resolved <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;msg.title&quot; . <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;msg.content&quot; . <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>重新启用下，让 webhook 项目应用到自定义模板：</p> <p>nohup ./prometheus-webhook-wechat --listen-port=':9999' --template.file=template.tmpl &amp;</p> <p><strong>5.测试报警与恢复</strong></p> <p>dd if=/dev/zero of=/dev/null bs=1G count=102400</p> <img src="/img/image-20250104200630210.png" alt="image-20250104200630210" style="zoom:80%;"> <img src="/img/image-20250104201130475.png" alt="image-20250104201130475" style="zoom:80%;"> <p>发现了1个问题，提供的告警来源主机是 localhost，接下来将 localhost 修改为 prometheus 主机的IP</p> <p>重新启动 promethus（加上参数）：nohup ./prometheus --web.external-url=http://10.0.0.20:9090 &amp;</p> <p>如果不方便重启 prometheus 还有一些别的方法，可以自行查阅资料</p> <img src="/img/image-20250104211553313.png" alt="image-20250104211553313" style="zoom:80%;"> <h5 id="_3-3-钉钉机器人-webhook"><a href="#_3-3-钉钉机器人-webhook" class="header-anchor">#</a> 3.3 钉钉机器人 WebHook</h5> <p>prometheus -- alertmanager -- rometheus-webhook-dingtalk -- 钉钉</p> <p>注册钉钉：http://oa.dingtalk.com</p> <p>随便注册1个企业</p> <p><img src="/img/image-20250105115329401.png" alt="image-20250105115329401" style="zoom:50%;">添加钉钉机器人（用 PC 端钉钉添加）</p> <p><img src="/img/image-20250105120511952.png" alt="image-20250105120511952" style="zoom:50%;">我们一般把告警信息发送给一个部门，然后把处理故障的人员添加到这个部门</p> <p>创建1个子部门，然后把自己的账号添加到该部门下</p> <p><img src="/img/image-20250105120902491.png" alt="image-20250105120902491" style="zoom:50%;"> <img src="/img/image-20250105121008834.png" alt="image-20250105121008834" style="zoom:50%;">回到钉钉，发现自动创建了部门群</p> <p><img src="/img/image-20250105121119007.png" alt="image-20250105121119007" style="zoom:50%;">设置 -- 机器人 -- 添加机器人 -- 自定义 -- 添加</p> <p><img src="/img/image-20250105130036204.png" alt="image-20250105130036204" style="zoom:50%;">添加机器人时需要添加 IP 地址/段，如果是虚拟环境部署的应用，可以在 ip138.com 查询本机IP</p> <p><img src="/img/image-20250105130328322.png" alt="image-20250105130328322" style="zoom:50%;">保存 webhook 地址</p> <p><img src="/img/image-20250105130440401.png" alt="image-20250105130440401" style="zoom:50%;">下载 prometheus-webhook-dingtalk：https://github.com/timonwong/prometheus-webhook-dingtalk</p> <p><strong>此项目使用 go 环境，先给下载 go ，然后配置环境变量</strong></p> <p>编译项目：go build -o prometheus-webhook-dingtalk ./cmd/prometheus-webhook-dingtalk</p> <p>配置文件（config.yml）：cp config.example.yml config.yml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">targets</span><span class="token punctuation">:</span>
  <span class="token key atrule">webhook1</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//oapi.dingtalk.com/robot/send<span class="token punctuation">?</span>access_token=7e9xxxxbb6xxxxa7b0c8b2e725aadxxxx24a2f9fae0d6
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> SEC000000000000000000000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>查看路由发现访问路径为（main.go）：/dingtalk/webhook1/send</p> <p>启动项目：nohup ./prometheus-webhook-dingtalk --web.listen-address=:8888 &amp;</p> <p><strong>配置 alertmanager.yml</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'dingtalk-webhook'</span>
  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">&quot;http://10.0.0.20:8888/dingtalk/webhook1/send&quot;</span>
      <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>测试报警与恢复</strong></p> <h5 id="_3-4-问题记录"><a href="#_3-4-问题记录" class="header-anchor">#</a> <img src="/img/image-20250105133640661.png" alt="image-20250105133640661" style="zoom:80%;"> <img src="/img/image-20250105133939915.png" alt="image-20250105133939915" style="zoom:80%;">3.4 问题记录</h5> <p>1.配置 go 环境变量</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/profile
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/usr/local/go/bin
<span class="token builtin class-name">source</span> /etc/profile
go version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2.编译 go 项目时卡住了</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 配置代理命令</span>
go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct
<span class="token comment"># 验证代理是否生效 输出类似 GOPROXY=&quot;https://goproxy.cn,direct&quot;</span>
go <span class="token function">env</span> <span class="token operator">|</span> <span class="token function">grep</span> GOPROXY
<span class="token comment"># 清理并重新拉取依赖</span>
go mod tidy
go build <span class="token parameter variable">-o</span> prometheus-webhook-wechat ./cmd/main.go
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>3.通过 main.go 找到 webhook 正确处理请求的地址</p> <p>4.修改 localhost 显示为我的 prometheus 的主机IP</p> <p>重新启动 promethus（加上参数）：nohup ./prometheus --web.external-url=http://10.0.0.20:9090 &amp;</p> <p>还可以修改模板信息来改变</p> <p>5.这些应用也提供了 Dockerfile 的方式帮助从 docker 构建，也可以试一下</p> <h5 id="_3-5-警报通知模板"><a href="#_3-5-警报通知模板" class="header-anchor">#</a> 3.5 警报通知模板</h5> <p>Prometheus 创建警报转发给 Alertmanager，Alertmanager 会根据不同的 Label 向不同的 Receiver 发送警报通知，如 Email、钉钉、企业微信、飞书、短信等等，所有 Receiver都一个接收模板，然后通过模板格式化以后发送警报信息给 Receiver</p> <p>Alertmanager 自带的模板是基于 Go 语言的 template 模板，用户可以根据自己的需求去定义自己需要的模板</p> <p><strong>邮件模板</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{{ define &quot;email.html&quot; }}
{{- if gt (len .Alerts.Firing) 0 -}}{{ range .Alerts }}
&lt;h2&gt;@告警通知&lt;/h2&gt;
告警程序: prometheus_alert &lt;br&gt;
告警级别: {{ . Labels.severity }} 级 &lt;br&gt;
告警类型: {{ . Labels.alertname }} &lt;br&gt;
故障主机: {{ . Labels.instance }} &lt;br&gt;
告警主题: {{ . Annotations.summary }} &lt;br&gt;
告警详情: {{ .Annotations.description }} &lt;br&gt;
触发时间: {{ . StartsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }} &lt;br&gt;
{{ end }}{{ end -}}
{{- if gt (len .Alerts.Resolved) 0 -}}{{ range .Alerts }}
&lt;h2&gt;@告警恢复&lt;/h2&gt;
告警程序: prometheus_alert &lt;br&gt;
故障主机: {{ .Labels.instance }} &lt;br&gt;
故障主题: {{ .Annotations.summary }} &lt;br&gt;
告警详情:{{ .Annotations.description }} &lt;br&gt;
告警时间: {{ .StartsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }} &lt;br&gt;
恢复时间: {{ .EndsAt.Local.Format &quot;2006-01-02 15:04:05&quot; }}&lt;br&gt;
{{ end }}{{ end -}}
{{- end }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>Wechat 模板</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cat wechat.tmpl
## wechat模板
{{ define &quot;wechat.default.message&quot; }}
{{ if gt (len .Alerts.Firing) 0 -}}
Alerts Firing:
{{ range .Alerts }}
警报级别：{{ .Labels.status }}

警报类型：{{ .Labels.alertname }}

故障主机: {{ .Labels.instance }}

警报主题: {{ .Annotations.summary }}

警报详情: {{ .Annotations.description }}

⏱ : {{ (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; }}
{{- end }}
{{- end }}

{{ if gt (len .Alerts.Resolved) 0 -}}
Alerts Resolved:
{{ range .Alerts }}
警报级别：{{ .Labels.status }}

警报类型：{{ .Labels.alertname }}

故障主机: {{ .Labels.instance }}

警报主题: {{ .Annotations.summary }}

警报详情: {{ .Annotations.description }}

⏱ : {{ (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; }}
⏲ : {{ (.EndsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; }}
{{- end }}
{{- end }}
{{- end }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>钉钉模板</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /etc/prometheus-webhook-dingtalk/template
cat default.tmpl
{{ define &quot;__subject&quot; }}[{{ .Status | toUpper }}{{ if eq .Status &quot;firing&quot; }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join &quot; &quot; }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join &quot; &quot; }}{{ end }}){{ end }}{{ end }}
{{ define &quot;__alertmanagerURL&quot; }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}

{{ define &quot;__text_alert_list&quot; }}{{ range . }}
**Labels**
{{ range .Labels.SortedPairs }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}
**Annotations**
{{ range .Annotations.SortedPairs }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}
**Source:** [{{ .GeneratorURL }}]({{ .GeneratorURL }})
{{ end }}{{ end }}

{{/* Firing */}}

{{ define &quot;default.__text_alert_list&quot; }}{{ range . }}

**Trigger Time:** {{ dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; }}

**Summary:** {{ .Annotations.summary }}

**Description:** {{ .Annotations.description }}

**Graph:** [📈 ]({{ .GeneratorURL }})

**Details:**
{{ range .Labels.SortedPairs }}{{ if and (ne (.Name) &quot;severity&quot;) (ne (.Name) &quot;summary&quot;) }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}{{ end }}
{{ end }}{{ end }}

{{/* Resolved */}}

{{ define &quot;default.__text_resolved_list&quot; }}{{ range . }}

**Trigger Time:** {{ dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; }}

**Resolved Time:** {{ dateInZone &quot;2006.01.02 15:04:05&quot; (.EndsAt) &quot;Asia/Shanghai&quot; }}

**Summary:** {{ .Annotations.summary }}

**Graph:** [📈 ]({{ .GeneratorURL }})

**Details:**
{{ range .Labels.SortedPairs }}{{ if and (ne (.Name) &quot;severity&quot;) (ne (.Name) &quot;summary&quot;) }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}{{ end }}
{{ end }}{{ end }}

{{/* Default */}}
{{ define &quot;default.title&quot; }}{{ template &quot;__subject&quot; . }}{{ end }}
{{ define &quot;default.content&quot; }}#### \[{{ .Status | toUpper }}{{ if eq .Status &quot;firing&quot; }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels &quot;alertname&quot; }}]({{ template &quot;__alertmanagerURL&quot; . }})**
{{ if gt (len .Alerts.Firing) 0 -}}

![Firing-img](https://is3-ssl.mzstatic.com/image/thumb/Purple20/v4/e0/23/cf/e023cf56-0623-0cdf-afce-97ae90eabfda/mzl.uplmrpgi.png/320x0w.jpg)

**Alerts Firing**
{{ template &quot;default.__text_alert_list&quot; .Alerts.Firing }}
{{- end }}
{{ if gt (len .Alerts.Resolved) 0 -}}

![Resolved-img](https://is3-ssl.mzstatic.com/image/thumb/Purple18/v4/41/72/99/4172990a-f666-badf-9726-6204a320c16e/mzl.dypdixoy.png/320x0w.png)

**Alerts Resolved**
{{ template &quot;default.__text_resolved_list&quot; .Alerts.Resolved }}
{{- end }}
{{- end }}

{{/* Legacy */}}
{{ define &quot;legacy.title&quot; }}{{ template &quot;__subject&quot; . }}{{ end }}
{{ define &quot;legacy.content&quot; }}#### \[{{ .Status | toUpper }}{{ if eq .Status &quot;firing&quot; }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels &quot;alertname&quot; }}]({{ template &quot;__alertmanagerURL&quot; . }})**
{{ template &quot;__text_alert_list&quot; .Alerts.Firing }}
{{- end }}

{{/* Following names for compatibility */}}
{{ define &quot;ding.link.title&quot; }}{{ template &quot;default.title&quot; . }}{{ end }}
{{ define &quot;ding.link.content&quot; }}{{ template &quot;default.content&quot; . }}{{ end }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><h3 id="grafana-onealert-告警"><a href="#grafana-onealert-告警" class="header-anchor">#</a> Grafana + OneAlert 告警</h3> <p>官网：https://www.aiops.com/</p> <p>1.进入 OneAlert 的智能告警平台 CloudAlert</p> <p>2.配置通知策略</p> <img src="/img/image-20241220135326557.png" alt="image-20241220135326557" style="zoom:80%;"> <p>3.配置分派策略</p> <img src="/img/image-20241220135437401.png" alt="image-20241220135437401" style="zoom:80%;"> <p>4.集成监控工具</p> <img src="/img/image-20241220135943375.png" alt="image-20241220135943375" style="zoom:80%;"> <p>5.Grafana 绑定 OneAlert</p> <img src="/img/image-20241220140418700.png" alt="image-20241220140418700" style="zoom:80%;"> <p>配置好后，可以点 Test 试一下，发现有个告警电话打过来了</p> <img src="/img/image-20241220140826087.png" alt="image-20241220140826087" style="zoom:80%;"> <p>6.设置告警策略</p> <img src="/img/image-20241220141328313.png" alt="image-20241220141328313" style="zoom:80%;"> <p>7.设置告警</p> <p>拿之前创建的模板举例</p> <img src="/img/image-20241220141611849.png" alt="image-20241220141611849" style="zoom:80%;"> <img src="/img/image-20241220142406131.png" alt="image-20241220142406131" style="zoom:80%;"> <img src="/img/image-20241220142633509.png" alt="image-20241220142633509" style="zoom:80%;"> <p>当 cpu 在 1 分钟内的负载大于 0.8 时告警</p> <img src="/img/image-20241220142722511.png" alt="image-20241220142722511" style="zoom:80%;"> <img src="/img/image-20241220143551479.png" alt="image-20241220143551479" style="zoom:80%;"> <img src="/img/image-20241220144046829.png" alt="image-20241220144046829" style="zoom:80%;"> <p>接下来压测 CPU：cat /dev/urandom | gzip -9 &gt; /dev/null</p> <img src="/img/image-20241220144527152.png" alt="image-20241220144527152" style="zoom:80%;"> <img src="/img/image-20241220144700878.png" alt="image-20241220144700878" style="zoom:80%;"> <img src="/img/image-20241220144846788.png" alt="image-20241220144846788" style="zoom:80%;"></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Prometheus" title="标签">#Prometheus</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/11/2025, 4:00:21 PM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/prometheus9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Grafana 数据可视化</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/prometheus9/" class="prev">Grafana 数据可视化</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://github.com/Janzhou1020" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="15629272568@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2025
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f4b69cc5.js" defer></script><script src="/assets/js/2.21d43cdc.js" defer></script><script src="/assets/js/116.c7015e4e.js" defer></script>
  </body>
</html>
